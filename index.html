<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survey Tracker v1.7</title>
<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #0b111b;
    color: #e0e6f0;
  }
  .app { max-width: 800px; margin: auto; padding: 12px; }
  header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  h1 { font-size: 1.3rem; margin: 0; }
  button {
    background: #1e293b;
    color: #e0e6f0;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover { background: #334155; }
  button.small { font-size: 0.85em; padding: 4px 8px; }
  button.muted { background: #2b364a; color: #a8b2c4; }
  input, textarea {
    background: #1e293b;
    color: #e0e6f0;
    border: none;
    border-radius: 6px;
    padding: 6px;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 8px;
  }
  .hidden { display: none; }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: #16a34a;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .toast.show { opacity: 1; }

  /* Screens */
  .screen { display: none; }
  .screen.active { display: block; }

  /* Targets */
  .target-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #1e293b;
    border-radius: 10px;
    padding: 8px;
    margin-bottom: 6px;
  }
  .target-row.found { background: #1a3b29; }

  .target-row img {
    max-height: 50px;
    border-radius: 6px;
    cursor: pointer;
  }

  .divider {
    border-top: 1px solid #2a3345;
    margin: 12px 0;
  }
  .archive {
    background: rgba(100,100,100,0.1);
    border-radius: 10px;
    padding: 6px;
  }

  /* Compass */
  #needle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 2px solid #e0e6f0;
    margin: auto;
    position: relative;
  }
  #arrow {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 2px;
    height: 40px;
    background: #e11d48;
    transform-origin: bottom center;
  }

  /* Modals */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .modal-backdrop.hidden { display: none; }
  .modal-card {
    background: #0f1724;
    border-radius: 12px;
    padding: 16px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  }

  #imageModal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.6);
  }

  .image-actions {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    gap: 12px;
  }

  .image-processing {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .spinner {
    border: 3px solid #e0e6f0;
    border-top: 3px solid transparent;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
    margin: 5px;
  }
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Survey Tracker</h1>
    <div>
      <button class="nav-btn" data-screen="homeScreen">üè†</button>
      <button class="nav-btn" data-screen="targetsScreen">üéØ</button>
      <button class="nav-btn" data-screen="compassScreen">üß≠</button>
    </div>
  </header>

  <!-- Home -->
  <section id="homeScreen" class="screen active">
    <button id="btnNewSurvey">New Survey</button>
    <div id="surveysList"></div>
  </section>

  <!-- Targets -->
  <section id="targetsScreen" class="screen">
    <div>
      <button id="btnAddTarget">Add Target</button>
      <button id="btnMarkFound" class="muted small">Mark Found</button>
    </div>
    <div class="targets" id="targetsList"></div>
  </section>

  <!-- Compass -->
  <section id="compassScreen" class="screen">
    <div id="compassArea" style="text-align:center;margin-top:20px;">
      <div id="needle">
        <div id="arrow"></div>
      </div>
      <div id="directionText" style="margin-top:12px;">Direction</div>
    </div>
    <div style="text-align:center;margin-top:20px;">
      <button id="btnFirst">‚èÆ First</button>
      <button id="btnPrev">‚óÄ Prev</button>
      <button id="btnNext">Next ‚ñ∂</button>
      <button id="btnLast">Last ‚è≠</button>
    </div>
  </section>

  <div id="toast" class="toast">Saved</div>

  <!-- Image modal -->
  <div id="imageModal" class="hidden modal-backdrop">
    <div style="text-align:center;">
      <img id="modalImage" alt="Enlarged target" />
      <div class="image-actions">
        <button id="btnChangeImg" class="small">Change</button>
        <button id="btnDeleteImg" class="small muted">Delete</button>
        <button id="btnCloseImg" class="small muted">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit modal -->
  <div id="editModal" class="hidden modal-backdrop">
    <div class="modal-card">
      <h3 id="modalTitle">Edit Target</h3>
      <input id="modalNote" placeholder="Target note" />
      <textarea id="modalDesc" rows="3" placeholder="Description (optional)"></textarea>
      <input id="modalFound" placeholder="Found item (optional)" />
      <div style="text-align:center;margin-top:8px">
        <img id="modalPreview" src="" alt="" style="max-height:180px;display:none;border-radius:8px;margin-bottom:6px">
        <input id="modalImageInput" type="file" accept="image/*" style="display:none">
        <button id="modalUpload" class="muted small">Upload Image</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="modalCancel" class="muted small">Cancel</button>
        <button id="modalSave">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
let data = JSON.parse(localStorage.getItem('surveyData')||'{"surveys":[]}');
function save(){ localStorage.setItem('surveyData',JSON.stringify(data)); showToast('Saved'); }
function showToast(t){ const el=document.getElementById('toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1500); }

const screens = document.querySelectorAll('.screen');
document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => {
  screens.forEach(sc => sc.classList.remove('active'));
  document.getElementById(btn.dataset.screen).classList.add('active');
}));

// --- Surveys ---
function renderSurveys(){
  const list=document.getElementById('surveysList');
  let open=data.surveys.find(s=>!s.closed);
  let html='';
  if(open){
    html+=`<div class="target-row"><b>${open.name}</b> (Open)
      <button id="btnCloseSurvey" class="small muted">Close</button></div>`;
  }
  const archived=data.surveys.filter(s=>s.closed);
  if(archived.length){
    html+=`<div class="divider"></div><div class="archive"><b>Archived Surveys</b>`;
    archived.forEach((s,i)=>{
      html+=`<div class="target-row">
        <span>${s.name}</span>
        <button class="restore-btn small" data-i="${i}">Restore</button>
      </div>`;
    });
    html+=`</div>`;
  }
  list.innerHTML=html;
  const btnClose=document.getElementById('btnCloseSurvey');
  if(btnClose) btnClose.onclick=()=>{ open.closed=true; save(); renderSurveys(); };
  document.querySelectorAll('.restore-btn').forEach(b=>b.addEventListener('click',()=>{
    const s=archived[b.dataset.i]; s.closed=false; save(); renderSurveys();
  }));
}
renderSurveys();

document.getElementById('btnNewSurvey').onclick=()=>{
  const name=prompt('Survey name?'); if(!name)return;
  data.surveys.unshift({name,targets:[],closed:false});
  save(); renderSurveys();
};

// --- Targets ---
const targetsList=document.getElementById('targetsList');
let selectedTargetId=null;
function getOpenSurvey(){ return data.surveys.find(s=>!s.closed); }

function renderTargets(){
  const s=getOpenSurvey(); if(!s){ targetsList.innerHTML='<p>No open survey.</p>'; return;}
  let html='';
  s.targets.forEach(t=>{
    const image=t.image?`<img src="${t.image}" class="clickable" data-id="${t.id}" alt="">`:'';
    html+=`<div class="target-row ${t.found?'found':''}">
      <span>${t.notes||'(no note)'}</span>
      <div>${image}
        <button class="small muted" data-act="goto" data-id="${t.id}">Goto</button>
        <button class="small muted" data-act="edit" data-id="${t.id}">Edit</button>
        <button class="small muted" data-act="delete" data-id="${t.id}">üóë</button>
      </div></div>`;
  });
  targetsList.innerHTML=html;
  targetsList.querySelectorAll('.clickable').forEach(img=>{
    img.addEventListener('click',()=>openImageModal(img.dataset.id));
  });
  targetsList.querySelectorAll('button[data-act]').forEach(btn=>btn.addEventListener('click',targetAction));
}
renderTargets();

document.getElementById('btnAddTarget').onclick=()=>{
  const s=getOpenSurvey(); if(!s)return alert('No open survey');
  const note=prompt('Target note?')||'';
  const id=Date.now();
  s.targets.push({id,notes:note,found:false});
  save(); renderTargets();
};

function targetAction(e){
  const act=e.target.dataset.act; const id=+e.target.dataset.id;
  const s=getOpenSurvey(); if(!s)return;
  const t=s.targets.find(x=>x.id===id); if(!t)return;
  if(act==='goto'){ selectedTargetId=id; showToast('Selected'); }
  else if(act==='edit'){ openEditModal(t,'edit'); }
  else if(act==='delete'){ if(confirm('Delete?')){ s.targets=s.targets.filter(x=>x.id!==id); save(); renderTargets(); } }
}

document.getElementById('btnMarkFound').onclick=()=>{
  const s=getOpenSurvey(); if(!s||!selectedTargetId){ alert('Select target first'); return;}
  const t=s.targets.find(x=>x.id===selectedTargetId); if(!t)return;
  openEditModal(t,'found');
};

// --- Compass dummy display ---
let bearing=0;
setInterval(()=>{ bearing=(bearing+10)%360;
  document.getElementById('arrow').style.transform=`rotate(${bearing}deg) translate(-50%,-50%)`;
  document.getElementById('directionText').textContent=`Slight right - ${Math.abs(180-bearing)}m`;
},1200);

// --- Image modal ---
const imageModal=document.getElementById('imageModal');
const modalImage=document.getElementById('modalImage');
const btnChangeImg=document.getElementById('btnChangeImg');
const btnDeleteImg=document.getElementById('btnDeleteImg');
const btnCloseImg=document.getElementById('btnCloseImg');

let currentImageTarget=null;

function openImageModal(id){
  const s=getOpenSurvey(); if(!s)return;
  currentImageTarget=s.targets.find(t=>t.id==id);
  if(!currentImageTarget||!currentImageTarget.image)return;
  modalImage.src=currentImageTarget.image;
  imageModal.classList.remove('hidden');
}

btnCloseImg.onclick=()=>imageModal.classList.add('hidden');
btnDeleteImg.onclick=()=>{
  if(!currentImageTarget)return;
  if(confirm('Delete image?')){
    currentImageTarget.image=null;
    save();
    renderTargets();
    imageModal.classList.add('hidden');
  }
};
btnChangeImg.onclick=()=>{
  if(!currentImageTarget)return;
  const input=document.createElement('input');
  input.type='file';
  input.accept='image/*';
  input.onchange=(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=(ev)=>{
      currentImageTarget.image=ev.target.result;
      save(); renderTargets(); showToast('Image changed');
      modalImage.src=ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  input.click();
};

// --- Edit modal ---
const editModal=document.getElementById('editModal');
const modalNote=document.getElementById('modalNote');
const modalDesc=document.getElementById('modalDesc');
const modalFound=document.getElementById('modalFound');
const modalPreview=document.getElementById('modalPreview');
const modalImageInput=document.getElementById('modalImageInput');
const modalUpload=document.getElementById('modalUpload');
const modalSave=document.getElementById('modalSave');
const modalCancel=document.getElementById('modalCancel');
const modalTitle=document.getElementById('modalTitle');

let currentEditTarget=null;
function openEditModal(target,mode='edit'){
  currentEditTarget=target;
  modalTitle.textContent=mode==='found'?'Mark Found':'Edit Target';
  modalNote.value=target.notes||'';
  modalDesc.value=target.description||'';
  modalFound.value=target.foundNote||'';
  if(target.image){ modalPreview.src=target.image; modalPreview.style.display='block'; }
  else modalPreview.style.display='none';
  editModal.classList.remove('hidden');
}
function closeEditModal(){ editModal.classList.add('hidden'); currentEditTarget=null; }

modalUpload.onclick=()=>modalImageInput.click();
modalCancel.onclick=()=>closeEditModal();

modalImageInput.onchange=(e)=>{
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    modalPreview.src=ev.target.result;
    modalPreview.style.display='block';
    if(currentEditTarget) currentEditTarget.image=ev.target.result;
  };
  r.readAsDataURL(f);
};

modalSave.onclick=()=>{
  if(!currentEditTarget)return;
  currentEditTarget.notes=modalNote.value.trim();
  currentEditTarget.description=modalDesc.value.trim();
  if(modalFound.value.trim()){ currentEditTarget.found=true; currentEditTarget.foundNote=modalFound.value.trim(); }
  save(); renderTargets(); showToast('Saved'); closeEditModal();
};
</script>
</body>
</html>
