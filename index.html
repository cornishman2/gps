<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survey Tracker</title>
<style>
  body {
    margin: 0; font-family: system-ui, sans-serif;
    background: #0b111b; color: #e0e6f0;
  }
  .app { max-width: 800px; margin: auto; padding: 12px; }
  header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  h1 { font-size: 1.3rem; margin: 0; }
  button {
    background: #1e293b; color: #e0e6f0; border: none; border-radius: 8px;
    padding: 8px 12px; cursor: pointer; transition: background 0.2s;
  }
  button:hover { background: #334155; }
  button.small { font-size: 0.85em; padding: 4px 8px; }
  button.muted { background: #2b364a; color: #a8b2c4; }
  input, textarea, select {
    background: #1e293b; color: #e0e6f0; border: none; border-radius: 6px;
    padding: 6px; width: 100%; box-sizing: border-box; margin-bottom: 8px;
  }
  .hidden { display: none; }
  .toast {
    position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
    background: #16a34a; color: white; padding: 8px 16px; border-radius: 8px;
    opacity: 0; transition: opacity 0.3s;
  }
  .toast.show { opacity: 1; }

  .screen { display: none; }
  .screen.active { display: block; }

  .targets { margin-top: 12px; }
  .target-row {
    display: flex; align-items: center; justify-content: space-between;
    background: #1e293b; border-radius: 10px; padding: 8px; margin-bottom: 6px;
  }
  .target-row.found { background: #1a3b29; }
  .target-row img {
    max-height: 50px; border-radius: 6px; cursor: pointer;
  }

  .divider {
    border-top: 1px solid #2a3345; margin: 12px 0;
  }
  .archive { background: rgba(100,100,100,0.1); border-radius: 10px; padding: 6px; }

  #compassCircle {
    width: 200px; height: 200px; border: 2px solid #e0e6f0;
    border-radius: 50%; margin: 20px auto; position: relative;
  }
  #compassArrow {
    position: absolute; left: 50%; top: 50%;
    width: 2px; height: 90px; background: #e11d48;
    transform-origin: bottom center; transition: transform 0.3s linear;
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Survey Tracker</h1>
    <div>
      <button class="nav-btn" data-screen="homeScreen">üè†</button>
      <button class="nav-btn" data-screen="targetsScreen">üéØ</button>
      <button class="nav-btn" data-screen="compassScreen">üß≠</button>
    </div>
  </header>

  <!-- Home -->
  <section id="homeScreen" class="screen active">
    <button id="btnNewSurvey">New Survey</button>
    <div id="surveysList"></div>
  </section>

  <!-- Targets -->
  <section id="targetsScreen" class="screen">
    <div>
      <button id="btnAddTarget">Add Target</button>
      <button id="btnMarkFound" class="muted small">Mark Found</button>
    </div>
    <div class="targets" id="targetsList"></div>
  </section>

  <!-- Compass -->
  <section id="compassScreen" class="screen" style="text-align:center">
    <div id="compassCircle">
      <div id="compassArrow"></div>
    </div>
    <div id="directionText" style="margin-top:12px;">Direction</div>
    <div style="text-align:center;margin-top:20px;">
      <button id="btnFirst">‚èÆ First</button>
      <button id="btnPrev">‚óÄ Prev</button>
      <button id="btnNext">Next ‚ñ∂</button>
      <button id="btnLast">Last ‚è≠</button>
    </div>
  </section>

  <div id="toast" class="toast">Saved</div>
</div>

<script>
let data = JSON.parse(localStorage.getItem('surveyData')||'{"surveys":[]}');
function save(){ localStorage.setItem('surveyData',JSON.stringify(data)); showToast('Saved'); }
function showToast(t){ const el=document.getElementById('toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1500); }

const homeScreen=document.getElementById('homeScreen');
const targetsScreen=document.getElementById('targetsScreen');
const compassScreen=document.getElementById('compassScreen');
const screens=[homeScreen,targetsScreen,compassScreen];
document.querySelectorAll('.nav-btn').forEach(btn=>btn.addEventListener('click',()=>{
  const s=btn.dataset.screen; screens.forEach(sc=>sc.classList.remove('active'));
  document.getElementById(s).classList.add('active');
}));

// --- Surveys ---
function renderSurveys(){
  const list=document.getElementById('surveysList');
  let open=data.surveys.find(s=>!s.closed);
  let html='';
  if(open){
    html+=`<div class="target-row"><b>${open.name}</b> (Open)
      <button id="btnCloseSurvey" class="small muted">Close</button></div>`;
  }
  const archived=data.surveys.filter(s=>s.closed);
  if(archived.length){
    html+=`<div class="divider"></div><div class="archive"><b>Archived Surveys</b>`;
    archived.forEach((s,i)=>{
      html+=`<div class="target-row">
        <span>${s.name}</span>
        <button class="restore-btn small" data-i="${i}">Restore</button>
      </div>`;
    });
    html+=`</div>`;
  }
  list.innerHTML=html;
  const btnClose=document.getElementById('btnCloseSurvey');
  if(btnClose) btnClose.onclick=()=>{ open.closed=true; save(); renderSurveys(); };
  document.querySelectorAll('.restore-btn').forEach(b=>b.addEventListener('click',()=>{
    const s=archived[b.dataset.i]; s.closed=false; save(); renderSurveys();
  }));
}
renderSurveys();

document.getElementById('btnNewSurvey').onclick=()=>{
  const name=prompt('Survey name?'); if(!name)return;
  data.surveys.unshift({name,targets:[],closed:false});
  save(); renderSurveys();
};

// --- Targets ---
const targetsList=document.getElementById('targetsList');
let selectedTargetId=null;
function getOpenSurvey(){ return data.surveys.find(s=>!s.closed); }

function renderTargets(){
  const s=getOpenSurvey(); if(!s){ targetsList.innerHTML='<p>No open survey.</p>'; return;}
  let html='';
  s.targets.forEach(t=>{
    const image=t.image?`<img src="${t.image}" class="clickable" alt="">`:'';
    html+=`<div class="target-row ${t.found?'found':''}">
      <span>${t.notes||'(no note)'}</span>
      <div>${image}
        <button class="small muted" data-act="goto" data-id="${t.id}">Goto</button>
        <button class="small muted" data-act="delete" data-id="${t.id}">üóë</button>
      </div></div>`;
  });
  targetsList.innerHTML=html;
  targetsList.querySelectorAll('button[data-act]').forEach(btn=>btn.addEventListener('click',targetAction));
}
renderTargets();

document.getElementById('btnAddTarget').onclick=()=>{
  const s=getOpenSurvey(); if(!s)return alert('No open survey');
  const note=prompt('Target note?')||'';
  const id=Date.now();
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    s.targets.push({id,notes:note,lat:latitude,lon:longitude,found:false});
    save(); renderTargets();
  },()=>{ alert('Location unavailable'); });
};

function targetAction(e){
  const act=e.target.dataset.act; const id=+e.target.dataset.id;
  const s=getOpenSurvey(); if(!s)return;
  const t=s.targets.find(x=>x.id===id); if(!t)return;
  if(act==='goto'){ selectedTargetId=id; showToast('Target selected'); }
  else if(act==='delete'){ if(confirm('Delete?')){ s.targets=s.targets.filter(x=>x.id!==id); save(); renderTargets(); } }
}

document.getElementById('btnMarkFound').onclick=()=>{
  const s=getOpenSurvey(); if(!s||!selectedTargetId){ alert('Select target first'); return;}
  const t=s.targets.find(x=>x.id===selectedTargetId); if(!t)return;
  t.found=true; save(); renderTargets(); showToast('Marked as found');
};

// --- Compass (Orientation Fixed) ---
const arrow=document.getElementById('compassArrow');
const dirText=document.getElementById('directionText');
let compassHeading=0;
let userLat=null,userLon=null;
let currentIndex=0;

function getTargets(){ const s=getOpenSurvey(); return s?s.targets:[]; }
function getCurrentTarget(){ const ts=getTargets(); return ts[currentIndex]; }

// Orientation fix
if(window.DeviceOrientationEvent){
  window.addEventListener("deviceorientationabsolute",handleCompass,true);
  window.addEventListener("deviceorientation",handleCompass,true);
}

function handleCompass(e){
  let heading=null;
  if(e.webkitCompassHeading!=null){ // iOS
    heading=e.webkitCompassHeading;
  } else if(e.alpha!=null){ // Android
    heading=360 - e.alpha;
  }
  if(heading!=null){
    compassHeading=heading;
  }
}

function updateCompass(){
  navigator.geolocation.getCurrentPosition(pos=>{
    userLat=pos.coords.latitude;
    userLon=pos.coords.longitude;
    const target=getCurrentTarget();
    if(!target){ dirText.textContent='No target'; return; }

    const distance=getDistance(userLat,userLon,target.lat,target.lon);
    const bearingToTarget=getBearing(userLat,userLon,target.lat,target.lon);
    
    // Fix arrow orientation by adding 180¬∞
    const relative=(bearingToTarget - compassHeading + 360 + 180) % 360;

    let direction='Ahead';
    if(relative>20 && relative<180) direction='Slight right';
    else if(relative>=180 && relative<340) direction='Slight left';
    else if(relative>=340 || relative<=20) direction='On target';

    arrow.style.transform=`rotate(${relative}deg)`;
    dirText.textContent=`${direction} - ${Math.round(distance)}m`;
  });
}

function getDistance(lat1,lon1,lat2,lon2){
  const R=6371000;
  const œÜ1=lat1*Math.PI/180, œÜ2=lat2*Math.PI/180;
  const ŒîœÜ=(lat2-lat1)*Math.PI/180, ŒîŒª=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function getBearing(lat1,lon1,lat2,lon2){
  const œÜ1=lat1*Math.PI/180, œÜ2=lat2*Math.PI/180;
  const Œª1=lon1*Math.PI/180, Œª2=lon2*Math.PI/180;
  const y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

setInterval(updateCompass,2000);

// Compass navigation
document.getElementById('btnFirst').onclick=()=>{ currentIndex=0; showToast('First target'); };
document.getElementById('btnPrev').onclick=()=>{ if(currentIndex>0) currentIndex--; showToast('Previous'); };
document.getElementById('btnNext').onclick=()=>{ if(currentIndex<getTargets().length-1) currentIndex++; showToast('Next'); };
document.getElementById('btnLast').onclick=()=>{ currentIndex=getTargets().length-1; showToast('Last target'); };
</script>
</body>
</html>
