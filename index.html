<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Metal Finder v3</title>
<style>
:root{
  --bg:#071018;--card:#0f1724;--accent:#16a34a;--muted:#98a2b3;--glass:rgba(255,255,255,0.03);
  --danger:#ef4444;--arch-tint:rgba(200,200,200,0.08);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6eef8;background:linear-gradient(180deg,#061019 0%,#0b1320 100%);-webkit-tap-highlight-color:transparent}
.app{max-width:980px;margin:0 auto;padding-bottom:84px}
header{display:flex;gap:12px;align-items:center;padding:12px}
h1{font-size:18px;margin:6px 0}
small{color:var(--muted)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);margin:12px}
.row{display:flex;gap:8px}
input,textarea,select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;width:100%}
input[type=file]{padding:6px}
button{background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
.muted{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px;border-radius:10px}
.small{font-size:12px;padding:6px}
.list{max-height:52vh;overflow:auto;padding:6px;border-radius:8px}
.survey-row,.target-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.01)}
.target-row{flex-direction:column;align-items:stretch}
.target-info{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.target-name{font-weight:600;font-size:14px}
.target-status{color:#16a34a;font-size:13px}
.survey-row.open{background:rgba(22,163,74,0.12);border:1px solid rgba(22,163,74,0.2)}
.survey-row.archived{background:var(--arch-tint);opacity:0.9}
.controls{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.coords{font-family:monospace;font-size:13px;color:var(--muted)}
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:64px;background:rgba(6,8,12,0.96);display:flex;align-items:center;justify-content:space-around;border-top:1px solid rgba(255,255,255,0.03);z-index:50}
.nav-btn{flex:1;text-align:center;color:var(--muted);font-weight:700;cursor:pointer}
.nav-btn.active{color:var(--accent)}
.hidden{display:none}
.arrow-wrap{width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);margin:12px auto}
.arrow{font-size:72px;transform-origin:center;transition:transform 0.2s ease-out}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;background:#111827;color:white;padding:8px 12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.6);display:none;z-index:60}
.divider{text-align:center;color:var(--muted);margin:10px 0;font-size:13px;border-top:1px solid rgba(255,255,255,0.08);padding-top:6px}
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:100}
.modal{background:var(--card);padding:16px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 6px 18px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:8px}
.modal img{width:100%;border-radius:8px;cursor:pointer;transition:transform 0.2s}
.modal img.enlarged{transform:scale(2);z-index:101;position:relative}
.modal textarea{resize:vertical;min-height:60px}
@media(min-width:700px){.bottom-nav{max-width:980px;margin:0 auto;left:50%;transform:translateX(-50%)}} 
</style>
</head>
<body>
<div class="app">
<header>
  <div>
    <h1>Metal Finder</h1>
    <small>v3 — with archive restore & photos</small>
  </div>
  <div style="margin-left:auto;text-align:right">
    <div class="coords">GPS: <span id="gpsText">unknown</span></div>
    <div class="coords">Accuracy: <span id="accText">—</span> m</div>
  </div>
</header>

<main>
  <section id="screen-home" class="card screen">
    <h3>Home — Surveys</h3>
    <div class="row">
      <input id="detectoristName" placeholder="Detectorist name" />
      <input id="detectorUsed" placeholder="Detector used" />
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnNewSurvey">+ New survey</button>
      <button id="btnNewSurveyAdd" class="muted small">New survey + add target</button>
      <button id="btnCloseSurvey" class="muted small">Close survey</button>
    </div>
    <div style="height:12px"></div>
    <strong>Surveys</strong>
    <div class="list" id="surveyList"></div>
  </section>

  <section id="screen-targets" class="card screen hidden">
    <h3>Targets</h3>
    <div class="row" style="align-items:center">
      <button id="btnAddTarget">+ Add target</button>
      <button id="btnBatch" class="muted small">Batch add</button>
      <div style="margin-left:auto" class="coords">Open survey: <span id="openSurveyName">—</span></div>
    </div>
    <div class="list" id="targetsList"></div>
  </section>

  <section id="screen-compass" class="card screen hidden">
    <h3>Compass</h3>
    <div style="height:8px"></div>
    <div class="coords" style="font-size:15px">Target: <strong id="compassTargetName">—</strong></div>
    <div class="coords" style="font-size:15px">Device heading: <span id="heading">—</span>°</div>
    <div class="coords" style="font-size:15px">Bearing to target: <span id="bearing">—</span>°</div>
    <div class="coords" style="font-size:14px;color:#16a34a;margin-top:4px"><span id="bearingText">—</span></div>
    <div style="height:8px"></div>
    <div class="arrow-wrap"><div class="arrow" id="arrow">↑</div></div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap">
      <button id="btnFirstTarget" class="muted small">First</button>
      <button id="btnPrevTarget" class="muted small">Prev</button>
      <button id="btnMarkFound">Mark Found</button>
      <button id="btnNextTarget" class="muted small">Next</button>
      <button id="btnLastTarget" class="muted small">Last</button>
    </div>
  </section>

  <section id="screen-settings" class="card screen hidden">
    <h3>Settings</h3>
    <div class="row" style="align-items:center">
      <button id="btnExport">Export JSON</button>
      <button id="btnImport" class="muted small">Import JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
    <div style="height:8px"></div>
    <div class="row" style="align-items:center">
      <button id="btnClear" class="small">Clear all data</button>
      <div style="margin-left:auto" class="coords">Version: <strong>metal_finder_v3</strong></div>
    </div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<div id="modalBg" class="modal-bg">
  <div class="modal">
    <strong>Mark Found</strong>
    <input id="shortNote" placeholder="Short note">
    <textarea id="longNote" placeholder="Additional description (optional)"></textarea>
    <input type="file" id="photosInput" accept="image/*" multiple>
    <div id="photoPreviews" class="row"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:8px">
      <button id="modalSave">Save</button>
      <button id="modalCancel" class="muted small">Cancel</button>
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <div class="nav-btn active" data-screen="home">Home</div>
  <div class="nav-btn" data-screen="targets">Targets</div>
  <div class="nav-btn" data-screen="compass">Compass</div>
  <div class="nav-btn" data-screen="settings">Settings</div>
</nav>
</div>

<script>
// --- Utility ---
function uid(p='id'){return p+Math.random().toString(36).slice(2,9);}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',1200);}

// --- Storage --- 
const STORAGE_KEY='metal_finder_v3_data';
let data=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{"surveys":[]}');
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(data));showToast('Saved');}

// --- Navigation ---
const screens={home:document.getElementById('screen-home'),targets:document.getElementById('screen-targets'),compass:document.getElementById('screen-compass'),settings:document.getElementById('screen-settings')};
const navBtns=[...document.querySelectorAll('.nav-btn')];
let currentScreen='home';
navBtns.forEach(b=>b.addEventListener('click',()=>{Object.values(screens).forEach(s=>s.classList.add('hidden'));screens[b.dataset.screen].classList.remove('hidden');navBtns.forEach(n=>n.classList.toggle('active',n===b));currentScreen=b.dataset.screen;}));

// --- Modal ---
const modalBg=document.getElementById('modalBg');
const shortNoteEl=document.getElementById('shortNote');
const longNoteEl=document.getElementById('longNote');
const photosInput=document.getElementById('photosInput');
const photoPreviews=document.getElementById('photoPreviews');
let modalTarget=null;
function openModal(target){
  modalTarget=target;
  shortNoteEl.value=target.foundNote||'';
  longNoteEl.value=target.foundDesc||'';
  photoPreviews.innerHTML='';
  if(target.photos){
    target.photos.forEach(src=>{
      const img=document.createElement('img');img.src=src;photoPreviews.appendChild(img);
      img.addEventListener('click',()=>img.classList.toggle('enlarged'));
    });
  }
  modalBg.style.display='flex';
}
document.getElementById('modalCancel').addEventListener('click',()=>{modalBg.style.display='none';});
document.getElementById('modalSave').addEventListener('click',()=>{
  modalTarget.foundNote=shortNoteEl.value;
  modalTarget.foundDesc=longNoteEl.value;
  modalTarget.photos=[];
  [...photoPreviews.children].forEach(img=>modalTarget.photos.push(img.src));
  save();
  modalBg.style.display='none';
});

// --- Photo input preview ---
photosInput.addEventListener('change',()=>{
  const files=[...photosInput.files].slice(0,3);
  photoPreviews.innerHTML='';
  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=document.createElement('img');
      img.src=e.target.result;
      photoPreviews.appendChild(img);
      img.addEventListener('click',()=>img.classList.toggle('enlarged'));
    };
    reader.readAsDataURL(file);
  });
});
</script>
</body>
</html>
