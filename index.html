<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green - Dig It! Survey Logger (Local App)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Tailwind Configuration */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', /* Blue 500 */
                        secondary: '#10b981', /* Emerald 500 - For action buttons */
                        card: '#ffffff',
                    }
                }
            }
        }
        /* Hide the dropdown content by default, show it on group-hover */
        .group:hover .group-hover\:block {
            display: block;
        }
        /* Sticky footer for the bottom navigation */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-4">Confirmation</h3>
            <p id="modal-message" class="text-sm text-gray-700 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <main id="app-content" class="pb-24 pt-4 min-h-screen"></main>

    <nav class="sticky-footer bg-white border-t border-gray-200 shadow-lg">
        <div class="max-w-xl mx-auto flex justify-around h-16">
            <button class="nav-btn flex flex-col items-center justify-center text-sm px-4 w-full transition-colors" data-page="home">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M11 11h2"></path></svg>
                <span class="mt-1">Home</span>
            </button>
            <button class="nav-btn flex flex-col items-center justify-center text-sm px-4 w-full transition-colors" data-page="targets">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="mt-1">Targets</span>
            </button>
            <button class="nav-btn flex flex-col items-center justify-center text-sm px-4 w-full transition-colors" data-page="compass">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                <span class="mt-1">Compass</span>
            </button>
            <button class="nav-btn flex flex-col items-center justify-center text-sm px-4 w-full transition-colors" data-page="settings">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="mt-1">Settings</span>
            </button>
        </div>
    </nav>

    <script type="module">
        // --- GLOBAL STATE ---
        let surveys = [];
        let currentPage = 'home';
        let userProfile = { name: "Local Digger", detector: "Nox 800" };
        let userId = null;
        const STORAGE_KEY = 'digit_survey_app_data';

        // --- UTILITY FUNCTIONS ---

        /** Generates a simple, unique ID. */
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        /** Formats an ISO date string to a readable format. */
        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        /** Shows a temporary message banner. */
        function showMessage(message, type = 'info') {
            const container = document.getElementById('app-content');
            let color = 'bg-blue-500';
            if (type === 'success') color = 'bg-secondary';
            if (type === 'error') color = 'bg-red-500';

            const alert = document.createElement('div');
            alert.className = `fixed top-0 left-0 right-0 p-3 text-center text-white ${color} z-50 shadow-lg transition-all duration-300`;
            alert.textContent = message;

            // Remove existing messages
            document.querySelectorAll('.fixed.top-0').forEach(el => el.remove());

            container.prepend(alert);
            setTimeout(() => {
                alert.remove();
            }, 3500);
        }

        /** Handles the display of the confirmation modal. */
        function showConfirmationModal(title, message, onConfirmCallback) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;

            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            // Clear previous listeners
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));

            const newConfirmBtn = document.getElementById('modal-confirm-btn');
            const newCancelBtn = document.getElementById('modal-cancel-btn');

            newConfirmBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                onConfirmCallback();
            };

            newCancelBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // --- DATA MANIPULATION FUNCTIONS (LOCAL STORAGE CRUD) ---

        /** Saves the current surveys and profile to Local Storage. */
        function saveSurveysToLocalStorage() {
            try {
                const data = {
                    surveys: surveys,
                    userProfile: userProfile,
                    userId: userId,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                showMessage("Error saving data to local storage.", 'error');
                console.error("Save Error:", e);
            }
        }

        /** Loads data from Local Storage or initializes defaults. */
        function loadDataFromLocalStorage() {
            let loadedData = null;
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    loadedData = JSON.parse(storedData);
                }
            } catch (e) {
                showMessage("Error parsing stored data. Starting fresh.", 'error');
                console.error("Load/Parse Error:", e);
            }

            if (loadedData && loadedData.userId) {
                surveys = loadedData.surveys || [];
                userProfile = loadedData.userProfile || userProfile;
                userId = loadedData.userId;
            } else {
                // Initialize default data if none exists
                userId = generateId();
                surveys = [
                    {
                        id: generateId(),
                        name: "First Site Survey (Active)",
                        description: "Standard site clearance and survey, area A.",
                        status: "Active",
                        creationDate: new Date(Date.now() - 86400000).toISOString(),
                        dateLastChanged: new Date(Date.now() - 86400000).toISOString(),
                        targets: [
                            { id: generateId(), time: new Date(Date.now() - 7200000).toISOString(), type: 'Coin', description: 'Small Copper Coin', vdi: '14', depth: '4 inches', coordinates: '50.12345, -5.67890', status: 'Signal Detected', user: 'Local Digger', detector: 'Nox 800' },
                            { id: generateId(), time: new Date(Date.now() - 3600000).toISOString(), type: 'Junk', description: 'Iron Nail', vdi: '8-10', depth: '6 inches', coordinates: '50.12350, -5.67895', status: 'Signal Ignored', user: 'Local Digger', detector: 'Nox 800' }
                        ]
                    },
                    {
                        id: generateId(),
                        name: "Phase 2 Area B (Open)",
                        description: "New area search, logging all non-ferrous.",
                        status: "Open",
                        creationDate: new Date().toISOString(),
                        dateLastChanged: new Date().toISOString(),
                        targets: [] // Starts empty
                    },
                    {
                        id: generateId(),
                        name: "Old Log (Archived)",
                        description: "Data from a 2023 dig.",
                        status: "Archived",
                        creationDate: new Date(Date.now() - 31536000000).toISOString(),
                        dateLastChanged: new Date(Date.now() - 31536000000).toISOString(),
                        targets: []
                    }
                ];
                saveSurveysToLocalStorage();
                showMessage("Initialized new data model and User ID.", 'info');
            }

            // Always ensure the targets are sorted newest first within the array
            surveys.forEach(survey => {
                if (survey.targets) {
                    survey.targets.sort((a, b) => new Date(b.time) - new Date(a.time));
                }
            });

            // Sort surveys by date last changed (most recent first)
            surveys.sort((a, b) => new Date(b.dateLastChanged) - new Date(a.dateLastChanged));
        }

        /** Clears the 'Open' status from all surveys. */
        function clearOpenStatus() {
            surveys.forEach(s => {
                if (s.status === 'Open') {
                    s.status = 'Active'; // Revert to Active
                    s.dateLastChanged = new Date().toISOString();
                }
            });
        }

        /** Creates a new survey via prompt. */
        function createNewSurvey() {
            const name = prompt("Enter the name for the new survey:", `New Survey Log ${surveys.length + 1}`);
            if (!name) return showMessage("Survey creation cancelled.", 'info');

            const description = prompt("Enter a brief description:", "A general area search.");
            if (!description === null) return showMessage("Survey creation cancelled.", 'info');

            // Clear any currently open survey
            clearOpenStatus();

            const newSurvey = {
                id: generateId(),
                name: name.trim(),
                description: description.trim(),
                status: 'Open', // Newly created survey starts 'Open'
                creationDate: new Date().toISOString(),
                dateLastChanged: new Date().toISOString(),
                targets: []
            };

            surveys.unshift(newSurvey); // Add to the start of the list
            saveSurveysToLocalStorage();
            loadDataFromLocalStorage(); // Reload and sort
            showMessage(`Success: New survey '${name}' created and set to Open.`, 'success');
            render();
        }

        /** Handles status changes (Open, Close, Archive, Restore). */
        function updateSurveyStatus(id, newStatus) {
            const survey = surveys.find(s => s.id === id);
            if (!survey) return showMessage("Error: Survey not found.", 'error');

            // Handle 'Open' action specifically: must close all others first
            if (newStatus === 'Open') {
                clearOpenStatus();
            }

            survey.status = newStatus;
            survey.dateLastChanged = new Date().toISOString();
            saveSurveysToLocalStorage();
            loadDataFromLocalStorage(); // Reload and sort
            showMessage(`Survey '${survey.name}' status updated to ${newStatus}.`, 'success');
            render();
        }

        /** Permanently deletes a survey using the confirmation modal. */
        function deleteSurvey(id, name) {
            showConfirmationModal(
                'Confirm Survey Deletion',
                `Are you sure you want to permanently delete the survey: "${name}"? This will delete all ${surveys.find(s => s.id === id)?.targets?.length || 0} targets within it. This action cannot be undone.`,
                // Confirmation callback (YES)
                () => {
                    const initialCount = surveys.length;
                    surveys = surveys.filter(s => s.id !== id);
                    if (surveys.length < initialCount) {
                        saveSurveysToLocalStorage();
                        loadDataFromLocalStorage();
                        showMessage(`Success: Survey '${name}' was permanently deleted.`, 'success');
                    } else {
                        showMessage(`Error: Survey '${name}' not found for deletion.`, 'error');
                    }
                    render();
                }
            );
        }
        
        // Target Action Handlers
        
        /** Updates a target's status, saving and re-rendering. */
        function updateTargetStatus(surveyId, targetId, newStatus) {
            const survey = surveys.find(s => s.id === surveyId);
            if (!survey) return showMessage("Survey not found.", 'error');

            const targetIndex = survey.targets.findIndex(t => t.id === targetId);
            if (targetIndex === -1) return showMessage("Target not found.", 'error');
            
            survey.targets[targetIndex].status = newStatus;
            survey.dateLastChanged = new Date().toISOString();

            saveSurveysToLocalStorage();
            loadDataFromLocalStorage();
            showMessage(`Target '${survey.targets[targetIndex].description}' status updated to '${newStatus}'.`, 'info');
            render();
        }

        /** Deletes a specific target using the confirmation modal. */
        function deleteTarget(surveyId, targetId, targetName) {
            showConfirmationModal(
                'Confirm Target Deletion',
                `Are you sure you want to permanently delete the target: "${targetName}"? This action cannot be undone.`,
                // Confirmation callback (YES)
                () => {
                    const survey = surveys.find(s => s.id === surveyId);
                    if (!survey) return showMessage("Survey not found during deletion.", 'error');

                    const initialCount = survey.targets.length;
                    survey.targets = survey.targets.filter(t => t.id !== targetId);

                    if (survey.targets.length < initialCount) {
                        survey.dateLastChanged = new Date().toISOString();
                        saveSurveysToLocalStorage();
                        loadDataFromLocalStorage();
                        showMessage(`Success: Target '${targetName}' was permanently deleted.`, 'success');
                    } else {
                        showMessage(`Error: Target '${targetName}' not found for deletion.`, 'error');
                    }
                    render();
                }
            );
        }

        /** Edits target details (simplified via prompts). */
        function editTarget(surveyId, targetId) {
            const survey = surveys.find(s => s.id === surveyId);
            if (!survey) return showMessage("Survey not found.", 'error');

            const target = survey.targets.find(t => t.id === targetId);
            if (!target) return showMessage("Target not found.", 'error');

            // Use current values as defaults for quick editing
            const newType = prompt("Edit Target Type:", target.type);
            if (newType === null) return showMessage("Edit cancelled.", 'info');

            const newDescription = prompt("Edit Description:", target.description);
            if (newDescription === null) return showMessage("Edit cancelled.", 'info');
            
            const newVdi = prompt("Edit VDI Reading:", target.vdi);
            if (newVdi === null) return showMessage("Edit cancelled.", 'info');
            
            const newDepth = prompt("Edit Depth:", target.depth);
            if (newDepth === null) return showMessage("Edit cancelled.", 'info');

            const newCoordinates = prompt("Edit GPS Coordinates:", target.coordinates);
            if (newCoordinates === null) return showMessage("Edit cancelled.", 'info');
            
            // Update target fields
            target.type = newType.trim();
            target.description = newDescription.trim();
            target.vdi = newVdi.trim();
            target.depth = newDepth.trim();
            target.coordinates = newCoordinates.trim();
            
            survey.dateLastChanged = new Date().toISOString();
            saveSurveysToLocalStorage();
            loadDataFromLocalStorage();
            showMessage(`Target '${target.description}' updated successfully.`, 'success');
            render();
        }

        /** Global handler for all survey actions (Open, Close, Archive, Delete). */
        window.handleSurveyAction = function(element) {
            const action = element.dataset.action;
            const id = element.dataset.id;
            const name = element.dataset.name;

            switch (action) {
                case 'open':
                    updateSurveyStatus(id, 'Open');
                    break;
                case 'close':
                    updateSurveyStatus(id, 'Active');
                    break;
                case 'archive':
                    updateSurveyStatus(id, 'Archived');
                    break;
                case 'restore':
                    updateSurveyStatus(id, 'Active');
                    break;
                case 'delete':
                    deleteSurvey(id, name);
                    break;
                default:
                    console.error("Unknown survey action:", action);
            }
        }
        
        /** Global handler for all target actions (Edit, Delete, Set Status). */
        window.handleTargetAction = function(element) {
            const action = element.dataset.action;
            const surveyId = element.dataset.surveyId;
            const targetId = element.dataset.id;
            const targetName = element.dataset.name;

            switch (action) {
                case 'delete':
                    deleteTarget(surveyId, targetId, targetName);
                    break;
                case 'edit':
                    editTarget(surveyId, targetId);
                    break;
                case 'setStatus':
                    const newStatus = element.dataset.status;
                    updateTargetStatus(surveyId, targetId, newStatus);
                    break;
                default:
                    console.error("Unknown target action:", action);
            }
        }

        /** Adds a new target to the survey currently marked as 'Open'. */
        function addTargetToOpenSurvey() {
            const openSurvey = surveys.find(s => s.status === 'Open');
            if (!openSurvey) {
                showMessage("Error: No survey is currently Open. Please open a survey on the Home page first.", 'error');
                return;
            }

            // --- Simplified Target Data Collection via Prompts ---
            const type = prompt("Enter Target Type (e.g., Coin, Relic, Junk):");
            if (!type) { showMessage("Target logging cancelled.", 'info'); return; }

            const description = prompt("Enter Description (e.g., 1901 Penny, Iron Nail):");
            if (!description) { showMessage("Target logging cancelled.", 'info'); return; }

            const vdi = prompt("Enter VDI Reading (Visual Display Indicator / Signal Number, e.g., 12, 8-10):", "N/A");
            
            const depth = prompt("Enter Depth (e.g., 6 inches, 15 cm):", "Unknown");
            const coordinates = prompt("Enter GPS Coordinates (e.g., 50.123, -5.456):", "N/A - Manual Log");
            // ---------------------------------------------------

            const newTarget = {
                id: generateId(),
                time: new Date().toISOString(),
                type: type.trim(),
                description: description.trim(),
                coordinates: coordinates.trim(),
                depth: depth.trim(),
                vdi: vdi.trim(),
                status: 'Signal Detected', // NEW FIELD: Target Status
                user: userProfile.name || 'Unknown Digger',
                detector: userProfile.detector || 'Unknown Machine'
            };

            // Find the index to update the survey directly
            const surveyIndex = surveys.findIndex(s => s.id === openSurvey.id);
            if (surveyIndex !== -1) {
                // Add the new target to the start of the targets array (newest first)
                surveys[surveyIndex].targets.unshift(newTarget);
                surveys[surveyIndex].dateLastChanged = new Date().toISOString();
                
                saveSurveysToLocalStorage();
                loadDataFromLocalStorage(); // Reload and sort
                
                showMessage(`Success: New target '${newTarget.type}' logged to survey '${openSurvey.name}'.`, 'success');
                render(); // Re-render the Targets page
            } else {
                showMessage("Error: Open survey state mismatch during target logging.", 'error');
            }
        }


        // --- PAGE RENDERING FUNCTIONS ---

        /** Main rendering function. */
        function render() {
            const contentDiv = document.getElementById('app-content');
            let pageContent = '';

            // Update navigation button active state
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const page = btn.dataset.page;
                const isActive = page === currentPage;
                btn.classList.toggle('text-primary', isActive);
                btn.classList.toggle('text-gray-500', !isActive);
                btn.classList.toggle('font-bold', isActive);
            });

            // Route to the correct page renderer
            switch (currentPage) {
                case 'home':
                    pageContent = renderHomePage();
                    break;
                case 'targets':
                    pageContent = renderTargetsPage();
                    break;
                case 'compass':
                    pageContent = renderCompassPage();
                    break;
                case 'settings':
                    pageContent = renderSettingsPage();
                    break;
            }

            contentDiv.innerHTML = `<div class="max-w-xl mx-auto">${pageContent}</div>`;
            
            // Attach specific event listeners after rendering
            if (currentPage === 'home') {
                document.getElementById('create-survey-btn')?.addEventListener('click', createNewSurvey);
            } else if (currentPage === 'targets') {
                document.getElementById('add-target-btn')?.addEventListener('click', addTargetToOpenSurvey);
            } else if (currentPage === 'settings') {
                document.getElementById('export-data-btn')?.addEventListener('click', exportData);
                document.getElementById('import-data-btn')?.addEventListener('click', importData);
            }
        }

        /** Renders the content for the Home page (Survey list). */
        function renderHomePage() {
            const openSurvey = surveys.find(s => s.status === 'Open');
            const surveyListHtml = surveys.map(s => renderSurveyCard(s, s.status === 'Open')).join('');
            
            return `
                <div class="p-4">
                    <h2 class="text-3xl font-bold text-primary mb-6">Survey Dashboard</h2>

                    <div class="bg-card p-4 rounded-lg shadow-md mb-6 border border-gray-100">
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">
                            Status: ${openSurvey ? openSurvey.name : '<span class="text-red-500">No Active Survey</span>'}
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">
                            ${openSurvey ? `Targets Logged: ${openSurvey.targets.length}` : 'Click "New Survey" to start a new logging session.'}
                        </p>
                        <button id="create-survey-btn" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-primary/90 transition duration-150 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            New Survey
                        </button>
                    </div>

                    <h3 class="text-2xl font-bold text-primary mb-3">All Surveys (${surveys.length})</h3>
                    <div id="survey-list" class="space-y-4">
                        ${surveyListHtml.length > 0 ? surveyListHtml : `<p class="text-gray-500 italic p-4 bg-white rounded-lg shadow-sm">No surveys found. Click 'New Survey' to begin.</p>`}
                    </div>
                </div>
            `;
        }

        /** Renders a single survey card with action buttons based on status. */
        function renderSurveyCard(survey, isOpen = false) {
            let actions = '';
            let statusBadge = '';

            switch (survey.status) {
                case 'Open':
                    statusBadge = `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">OPEN</span>`;
                    // FIX 2: Restored original colors/text contrast. Yellow button uses black text.
                    actions = `
                        <button class="survey-action-btn bg-yellow-500 hover:bg-yellow-600 p-2 text-black text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="close" data-name="${survey.name}">Close</button>
                        <button class="survey-action-btn bg-red-500 hover:bg-red-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="archive" data-name="${survey.name}">Archive</button>
                    `;
                    break;
                case 'Active': // Active but Closed
                    statusBadge = `<span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">ACTIVE</span>`;
                    // FIX 2: Restored Open button to green background with white text.
                    actions = `
                        <button class="survey-action-btn bg-secondary hover:bg-secondary/90 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="open" data-name="${survey.name}">Open</button>
                        <button class="survey-action-btn bg-red-500 hover:bg-red-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="archive" data-name="${survey.name}">Archive</button>
                        <button class="survey-action-btn bg-gray-500 hover:bg-gray-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="delete" data-name="${survey.name}">Delete</button>
                    `;
                    break;
                case 'Archived':
                    statusBadge = `<span class="bg-gray-100 text-gray-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">ARCHIVED</span>`;
                    // FIX 2: Restored Restore button to green background with white text.
                    actions = `
                        <button class="survey-action-btn bg-secondary hover:bg-secondary/90 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="restore" data-name="${survey.name}">Restore to Active</button>
                        <button class="survey-action-btn bg-gray-500 hover:bg-gray-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="delete" data-name="${survey.name}">Delete</button>
                    `;
                    break;
            }

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 ${isOpen ? 'border-green-500' : 'border-primary'}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-gray-800">${statusBadge} ${survey.name}</h3>
                        <div class="text-right text-sm text-gray-500">
                            <p>Created: ${formatDate(survey.creationDate)}</p>
                            <p>Updated: ${formatDate(survey.dateLastChanged)}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${survey.description}</p>
                    <p class="text-sm font-semibold text-gray-700">Targets Logged: ${survey.targets ? survey.targets.length : 0}</p>
                    
                    <div class="mt-4 pt-3 border-t border-gray-100 flex flex-wrap gap-2">
                        ${actions}
                    </div>
                </div>
            `;
        }
        
        /** Renders a single target card with status and actions. */
        function renderTargetCard(target, surveyId) {
            // Define status styles
            let statusClass = 'bg-gray-100 text-gray-800';
            let statusIcon = `<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

            switch (target.status) {
                case 'Hole Dug':
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusIcon = `<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>`;
                    break;
                case 'Hole Refilled':
                    statusClass = 'bg-secondary/10 text-secondary';
                    statusIcon = `<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4M18 5h2M17 19h4m-7-6l-3-3 6-6m-3 9l3-3m-3 3l-6 6"></path></svg>`;
                    break;
                case 'Signal Ignored':
                    statusClass = 'bg-red-100 text-red-800';
                    statusIcon = `<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                    break;
                case 'Signal Detected':
                default:
                    statusClass = 'bg-blue-100 text-blue-800';
                    statusIcon = `<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3-.895-3-2 1.343-2 3-2zM12 20s-7-12-7-15a7 7 0 0114 0c0 3-7 15-7 15z"></path></svg>`;
                    break;
            }

            const typeBadgeClass = target.type.toLowerCase().includes('junk') ? 'bg-red-200 text-red-900' : 'bg-primary/10 text-primary';
            
            // Status Action Dropdown
            const statusOptions = ['Signal Detected', 'Hole Dug', 'Hole Refilled', 'Signal Ignored'];
            const actionDropdown = statusOptions.filter(s => s !== target.status).map(status => `
                <li>
                    <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="${status}" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        Set to ${status}
                    </a>
                </li>
            `).join('');

            return `
                <div class="bg-card p-4 rounded-xl shadow-md border-l-4 border-gray-200">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex flex-col">
                            <h4 class="text-xl font-bold text-gray-800">${target.description}</h4>
                            <span class="${typeBadgeClass} text-xs font-semibold px-2.5 py-0.5 rounded">${target.type}</span>
                        </div>
                        
                        <div class="relative inline-block text-left group">
                            <button id="dropdownMenuButton-${target.id}" class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-2 py-1 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" aria-expanded="true" aria-haspopup="true">
                                Actions
                                <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            
                            <div class="origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden group-hover:block z-10">
                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="dropdownMenuButton-${target.id}">
                                    ${actionDropdown}
                                    <div class="border-t border-gray-100"></div>
                                    <a href="#" onclick="handleTargetAction(this)" data-action="edit" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        Edit Details
                                    </a>
                                    <a href="#" onclick="handleTargetAction(this)" data-action="delete" data-id="${target.id}" data-name="${target.description}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                        Delete Target
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-xs font-semibold px-2.5 py-0.5 rounded-full inline-flex items-center ${statusClass}">
                        ${statusIcon} ${target.status}
                    </p>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm mt-3 pt-3 border-t border-gray-100">
                        <div>
                            <strong class="text-gray-500">VDI:</strong> <span class="text-gray-800">${target.vdi}</span>
                        </div>
                        <div>
                            <strong class="text-gray-500">Depth:</strong> <span class="text-gray-800">${target.depth}</span>
                        </div>
                        <div class="sm:col-span-2">
                            <strong class="text-gray-500">Location:</strong> <span class="text-gray-800 break-all">${target.coordinates}</span>
                        </div>
                        <div class="col-span-2 sm:col-span-4 text-xs text-gray-400">
                            Logged at ${new Date(target.time).toLocaleTimeString()} on ${formatDate(target.time)} by ${target.user} (${target.detector})
                        </div>
                    </div>
                </div>
            `;
        }

        /** Renders the content for the Targets page. */
        function renderTargetsPage() {
            const openSurvey = surveys.find(s => s.status === 'Open');
            const targets = openSurvey ? openSurvey.targets : [];
            const surveyId = openSurvey ? openSurvey.id : null;

            let targetsListHtml = '';
            if (targets.length === 0) {
                targetsListHtml = `<p class="text-gray-500 italic p-4 bg-white rounded-lg shadow-sm">No targets logged in this survey yet. Click 'Log New Target' to record your first find!</p>`;
            } else {
                targetsListHtml = targets.map(t => renderTargetCard(t, surveyId)).join('');
            }
            
            const isButtonDisabled = !openSurvey;

            return `
                <div class="p-4">
                    <h2 class="text-3xl font-bold text-primary mb-6">Targets Log</h2>

                    <div class="bg-card p-4 rounded-lg shadow-md mb-6 border border-gray-100">
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">
                            Current Survey: ${openSurvey ? openSurvey.name : '<span class="text-red-500">None Open</span>'}
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">
                            ${openSurvey ? openSurvey.description : 'Open a survey on the Home page to start logging finds.'}
                        </p>

                        <button id="add-target-btn" class="w-full font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 flex items-center justify-center 
                            ${isButtonDisabled 
                                ? 'bg-gray-300 text-gray-600 opacity-50 cursor-not-allowed border border-gray-400'
                                : 'bg-secondary hover:bg-secondary/90 text-white'}" 
                            ${isButtonDisabled ? 'disabled' : ''}>
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Log New Target
                        </button>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-primary mb-3">Survey Targets (${targets.length})</h3>
                    <div id="targets-list" class="space-y-4">
                        ${targetsListHtml}
                    </div>
                </div>
            `;
        }

        /** Renders the content for the Compass page. */
        function renderCompassPage() {
            return `
                <div class="p-4">
                    <h2 class="text-3xl font-bold text-primary mb-6">Compass/GPS Page</h2>
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                        <p class="text-gray-700">This page would typically show a compass or map interface to help you log target locations using device GPS. (Functionality coming soon)</p>
                    </div>
                </div>
            `;
        }

        // --- DATA EXPORT/IMPORT FUNCTIONS ---

        /** Generates and displays the JSON data for export. */
        function exportData() {
            const dataToExport = { surveys, userProfile, userId, timestamp: new Date().toISOString() };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            document.getElementById('export-data-area').value = jsonString;
            showMessage("Data export generated. Copy the text below.", 'success');
        }

        /** Imports data from the textarea and overwrites local data. */
        function importData() {
            const importArea = document.getElementById('import-data-area');
            const jsonString = importArea.value.trim();

            if (!jsonString) {
                return showMessage("Please paste JSON data into the box first.", 'error');
            }

            showConfirmationModal(
                'Confirm Data Import & OVERWRITE',
                "Are you absolutely sure you want to import this data? It will **permanently overwrite** all your existing local survey data.",
                // Confirmation callback (YES)
                () => {
                    try {
                        const importedData = JSON.parse(jsonString);
                        
                        // Basic validation
                        if (!importedData.surveys || !Array.isArray(importedData.surveys)) {
                            throw new Error("Invalid import structure. Missing 'surveys' array.");
                        }

                        // Overwrite global state
                        surveys = importedData.surveys;
                        userProfile = importedData.userProfile || { name: "Imported User", detector: "Imported Machine" };
                        userId = importedData.userId || generateId(); // Keep old ID if present, otherwise generate new

                        saveSurveysToLocalStorage();
                        loadDataFromLocalStorage();
                        showMessage("Data import successful! Local data has been overwritten.", 'success');
                        importArea.value = ''; // Clear input after successful import
                        render();
                    } catch (e) {
                        showMessage(`Import Failed: ${e.message}`, 'error');
                        console.error("Import Error:", e);
                    }
                }
            );
        }

        /** Renders the content for the Settings page. */
        function renderSettingsPage() {
            return `
                <div class="p-4">
                    <h2 class="text-3xl font-bold text-primary mb-6">Settings & Local Data Management</h2>

                    <div class="mb-8">
                        <p class="text-lg font-semibold text-gray-700">Your Local User ID</p>
                        <p class="mt-2 p-2 bg-gray-100 rounded-lg font-mono text-sm break-all">${userId || 'Error: ID Missing'}</p>
                        <p class="text-xs text-red-500 mt-2">ðŸ›‘ WARNING: This ID ties your data to this browser/device only. This data is NOT synced to the cloud.</p>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-lg mb-8 border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Export Data (Backup / Manual Transfer)</h3>
                        <p class="text-sm text-gray-600 mb-3">Click the button to generate a complete JSON backup of all your surveys and profile data. You can copy this text and save it elsewhere or import it on another device.</p>
                        
                        <button id="export-data-btn" class="w-full bg-primary text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-primary/90 transition duration-150 mb-4">
                            Generate Export JSON
                        </button>
                        <textarea id="export-data-area" rows="10" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 text-xs font-mono"></textarea>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Import Data (Restore / Manual Transfer)</h3>
                        <p class="text-sm text-gray-600 mb-3">Paste the exported JSON text here and click Import. **Warning:** This will overwrite any existing local data on this device.</p>
                        
                        <textarea id="import-data-area" rows="10" placeholder="Paste your exported JSON data here..." class="w-full p-2 border border-yellow-500 rounded-md font-mono text-xs mb-4"></textarea>
                        <button id="import-data-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                            Import & Overwrite Local Data
                        </button>
                    </div>
                </div>
            `;
        }


        // --- INITIALIZATION & EVENT LISTENERS ---

        // Event listener for navigation buttons
        document.querySelectorAll('.nav-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetPage = e.currentTarget.dataset.page;
                if (targetPage && targetPage !== currentPage) {
                    currentPage = targetPage;
                    render();
                }
            });
        });

        // 1. Load data first
        loadDataFromLocalStorage();
        showMessage("Data loaded instantly from local storage.", 'success'); // Show initial load message

        // 2. Initial render call
        render();

    </script>
</body>
</html>
