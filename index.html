<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidence 7  - Metal Detecting Survey Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    
    <style>
        /* Custom colors using CSS variables for guaranteed consistency */
        :root {
            --color-primary: 29 78 216;      /* Blue (For contrast/borders) */
            --color-secondary: 34 197 94;    /* Vibrant Green (For action buttons) */
            --color-background: 243 244 246; /* Light Gray */
            --color-card: 255 255 255;       /* White */
        }

        /* Configure Tailwind to use the custom variables (kept for other classes like text-primary) */
        tailwind-config {
            theme: {
                extend: {
                    colors: {
                        primary: 'rgb(var(--color-primary) / <alpha-value>)',
                        secondary: 'rgb(var(--color-secondary) / <alpha-value>)',
                        background: 'rgb(var(--color-background) / <alpha-value>)',
                        card: 'rgb(var(--color-card) / <alpha-value>)',
                    }
                }
            }
        }

        /* Basic App Styling */
        body {
            font-family: 'Arial', sans-serif;
            background-color: rgb(var(--color-background));
        }

        /* Ensure the modal is hidden by default and handles clicks outside */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            margin: 10vh auto;
            border-radius: 12px;
            max-width: 500px;
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-40">
        <div class="container mx-auto max-w-lg">
            <div class="flex items-center justify-between p-4">
                <h1 class="text-xl font-extrabold text-primary">GeoFind Log</h1>
                <div class="flex space-x-2">
                    <button class="nav-btn p-2 rounded-full text-gray-500 hover:text-primary transition duration-150" data-page="Home">
                        <i class="fas fa-home text-xl"></i>
                    </button>
                    <button class="nav-btn p-2 rounded-full text-gray-500 hover:text-primary transition duration-150" data-page="Targets">
                        <i class="fas fa-bullseye text-xl"></i>
                    </button>
                    <button class="nav-btn p-2 rounded-full text-gray-500 hover:text-primary transition duration-150" data-page="Compass">
                        <i class="fas fa-compass text-xl"></i>
                    </button>
                    <button class="nav-btn p-2 rounded-full text-gray-500 hover:text-primary transition duration-150" data-page="Settings">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main id="app-content" class="container mx-auto max-w-lg pt-20 pb-4 min-h-screen"></main>

    <div id="message-toast" class="fixed bottom-4 right-4 z-50 p-4 rounded-lg text-white shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none" style="min-width: 250px;"></div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content bg-white p-6 shadow-2xl">
            <h3 id="confirm-title" class="text-xl font-bold text-red-600 mb-4">Confirmation</h3>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-no-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirm-yes-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">Yes, Proceed</button>
            </div>
        </div>
    </div>
    
    <div id="new-survey-modal" class="modal">
        <div class="modal-content bg-white p-6 shadow-2xl">
            <h3 class="text-xl font-bold text-primary mb-4">Create New Survey</h3>
            <form id="new-survey-form">
                <div class="mb-4">
                    <label for="survey-name" class="block text-sm font-medium text-gray-700">Survey Name *</label>
                    <input type="text" id="survey-name" name="surveyName" required 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                </div>
                <div class="mb-4">
                    <label for="survey-description" class="block text-sm font-medium text-gray-700">Description / Location</label>
                    <textarea id="survey-description" name="surveyDescription" rows="3" 
                              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary"></textarea>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeNewSurveyModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150"
                            style="background-color: rgb(var(--color-secondary));">
                        Create & Open
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="new-target-modal" class="modal">
        <div class="modal-content bg-white p-6 shadow-2xl">
            <h3 class="text-xl font-bold text-primary mb-4">Log New Target</h3>
            <form id="new-target-form">
                
                <div id="target-survey-display" class="bg-gray-100 p-2 rounded-md mb-4 text-sm font-semibold text-gray-700">
                    Logging for: <span id="current-target-survey-name" class="text-primary">Loading...</span>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4 col-span-2">
                        <label for="target-description" class="block text-sm font-medium text-gray-700">Description / Find Name *</label>
                        <input type="text" id="target-description" name="targetDescription" required 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="target-vdi" class="block text-sm font-medium text-gray-700">Target ID</label>
                        <input type="text" id="target-vdi" name="targetVDI" placeholder="e.g., 28" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="target-depth" class="block text-sm font-medium text-gray-700">Depth</label>
                        <input type="text" id="target-depth" name="targetDepth" placeholder="e.g., 6 inches"
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4 col-span-2">
                        <label for="target-type" class="block text-sm font-medium text-gray-700">Type of Find *</label>
                        <select id="target-type" name="targetType" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary bg-white">
                            <option value="Unidentified">Unidentified</option>
                            <option value="Iron Junk">Iron Junk</option>
                            <option value="Modern Junk">Modern Junk</option>
                             <option value="Coin">Coin</option>
                            <option value="Ring">Ring</option>
                            <option value="Jewelry">Jewelry</option>
                            <option value="Relic">Relic</option>
                            <option value="Something else.">Something else</option>

                        </select>
                    </div>
                    <div class="mb-4 col-span-2">
                        <label for="target-coords" class="block text-sm font-medium text-gray-700 flex items-center">
                            GPS Coordinates
                            <span id="gps-loading-indicator" class="ml-2 text-primary text-xs hidden">
                                <i class="fas fa-spinner fa-spin mr-1"></i> Locating...
                            </span>
                        </label>
                        <input type="text" id="target-coords" name="targetCoords" placeholder="Requesting location..." 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                        <input type="hidden" id="target-accuracy" name="targetAccuracy">
                        <p id="gps-accuracy-display" class="text-xs text-gray-500 mt-1 hidden">Accuracy (Radius): <span class="font-semibold text-red-600">N/A</span></p>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeNewTargetModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150"
                            style="background-color: rgb(var(--color-secondary));">
                        Log Target
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-target-modal" class="modal">
        <div class="modal-content bg-white p-6 shadow-2xl">
            <h3 class="text-xl font-bold text-primary mb-4">Edit Target Details</h3>
            <form id="edit-target-form">
                <input type="hidden" id="edit-target-id" name="targetId">
                <input type="hidden" id="edit-survey-id" name="surveyId">

                <div id="edit-target-survey-display" class="bg-gray-100 p-2 rounded-md mb-4 text-sm font-semibold text-gray-700">
                    Editing target in: <span id="current-edit-survey-name" class="text-primary">Loading...</span>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4 col-span-2">
                        <label for="edit-target-description" class="block text-sm font-medium text-gray-700">Description / Find Name *</label>
                        <input type="text" id="edit-target-description" name="targetDescription" required 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="edit-target-vdi" class="block text-sm font-medium text-gray-700">Target ID</label>
                        <input type="text" id="edit-target-vdi" name="targetVDI" placeholder="e.g., 28" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="edit-target-depth" class="block text-sm font-medium text-gray-700">Depth</label>
                        <input type="text" id="edit-target-depth" name="targetDepth" placeholder="e.g., 6 inches"
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4 col-span-2">
                        <label for="edit-target-type" class="block text-sm font-medium text-gray-700">Type of Find *</label>
                        <select id="edit-target-type" name="targetType" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary bg-white">
                            <option value="Unidentified">Unidentified</option>
                            <option value="Iron Junk">Iron Junk</option>
                            <option value="Modern Junk">Modern Junk</option>
                             <option value="Coin">Coin</option>
                            <option value="Ring">Ring</option>
                            <option value="Jewelry">Jewelry</option>
                            <option value="Relic">Relic</option>
                            <option value="Something else.">Something else</option>
                        </select>
                    </div>
                    <div class="mb-4 col-span-2">
                        <label for="edit-target-coords" class="block text-sm font-medium text-gray-700">GPS Coordinates</label>
                        <input type="text" id="edit-target-coords" name="targetCoords" placeholder="e.g., 50.2568, -5.2345" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                    </div>
                    <div class="mb-4 col-span-2">
                        <label for="edit-target-accuracy" class="block text-sm font-medium text-gray-700">GPS Accuracy (m)</label>
                        <input type="text" id="edit-target-accuracy" name="targetAccuracy" placeholder="e.g., 5.0" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditTargetModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150"
                            style="background-color: rgb(var(--color-secondary));">
                        Save Target Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content bg-white p-6 shadow-2xl">
            <h3 class="text-xl font-bold text-primary mb-4">Edit Detectorist Profile</h3>
            <form id="edit-profile-form">
                <div class="mb-4">
                    <label for="profile-name" class="block text-sm font-medium text-gray-700">Detectorist Name *</label>
                    <input type="text" id="profile-name" name="profileName" required 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                </div>
                <div class="mb-4">
                    <label for="profile-detector" class="block text-sm font-medium text-gray-700">Detector Used</label>
                    <input type="text" id="profile-detector" name="profileDetector" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditProfileModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150"
                            style="background-color: rgb(var(--color-secondary));">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- GLOBAL STATE & INITIALIZATION ---
        
// --- GLOBAL STATE & INITIALIZATION ---
        let surveys = [];
        let currentPage = 'Home';
        let isMapFullscreen = false; // <--- ADD THIS LINE
        // --- GLOBAL STATE ---
        let targetWatchId = null; // <--- ADD THIS to track the specific GPS process for the modal
        
        // Profile initialized with default data
        let userProfile = {
            name: "New User",
            detector: "Default Machine"
        };
        let userId;

      // --- NEW REAL-TIME LOCATION STATE ---
let autoRefreshIntervalId = null; 
let currentUserCoords = null; // Stores {lat: number, lon: number}
let currentUserAccuracy = null; // Stores accuracy in meters

// ADD THESE FOR LIVE MAP ACCURACY LOGIC:
let liveMapWatchId = null;      // To track the watchPosition process for the live map
let bestLiveAccuracy = Infinity; // To track the best accuracy received (lower is better)

        
        // --- GEOGRAPHY HELPER FUNCTIONS ---

        /** Converts degrees to radians. */
        function toRad(degrees) {
            return degrees * (Math.PI / 180);
        }

        /** Converts radians to degrees. */
        function toDeg(radians) {
            return radians * (180 / Math.PI);
        }
        
        /** Clamps a number between a minimum and maximum value. */
        const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

        /** Calculates the diameter for the confidence circle (Accuracy * 2). */
        function getCircleDiameter(accuracyInMeters) {
            if (typeof accuracyInMeters === 'number' && accuracyInMeters > 0) {
                // Diameter is twice the radius (accuracy)
                return (accuracyInMeters * 2).toFixed(1); 
            }
            return 'N/A';
        }

        // --- END GEOGRAPHY HELPER FUNCTIONS ---


        // --- HELPER FUNCTIONS ---

        /** Generates a simple unique ID. */
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
        }

        /** Formats a timestamp into a readable date string. */
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString();
        }

        /** Saves the current surveys and profile data to Local Storage. */
        function saveSurveysToLocalStorage() {
            try {
                localStorage.setItem('geoFindSurveys', JSON.stringify(surveys));
                localStorage.setItem('geoFindProfile', JSON.stringify(userProfile));
                localStorage.setItem('geoFindUserId', userId);
            } catch (e) {
                console.error("Error saving to Local Storage:", e);
                showMessage("Error saving data locally.", 'error');
            }
        }

        /** Loads data from Local Storage. Initializes if no data found. */
        function loadDataFromLocalStorage() {
            try {
                const storedSurveys = localStorage.getItem('geoFindSurveys');
                const storedProfile = localStorage.getItem('geoFindProfile');
                const storedUserId = localStorage.getItem('geoFindUserId');

                if (storedSurveys) {
                    surveys = JSON.parse(storedSurveys);
                } else {
                    // Initialize with sample data if nothing is found
                    surveys = [
                        {
                            id: generateId(),
                            name: "Sample Grid Survey 2025",
                            description: "Testing a 10x10 metre grid near the old oak tree.",
                            status: 'Open',
                            creationDate: Date.now(),
                            dateLastChanged: Date.now(),
                            targets: [
                                // Sample targets with valid coordinates and accuracy for mapping
                                { id: generateId(), description: "Small Copper Coin", vdi: "28", depth: "4in", type: "Coin", status: "Signal Detected", time: Date.now(), coordinates: "50.256800, -5.234500", accuracy: "5.5", user: userProfile.name, detector: userProfile.detector },
                                { id: generateId(), description: "Lead Button", vdi: "30", depth: "6in", type: "Relic", status: "Signal Detected", time: Date.now() - 100000, coordinates: "50.257000, -5.234100", accuracy: "2.1", user: userProfile.name, detector: userProfile.detector },
                                { id: generateId(), description: "Iron Spike", vdi: "8", depth: "12in", type: "Iron Junk", status: "Signal Ignored", time: Date.now() - 3600000, coordinates: "50.256700, -5.234800", accuracy: "10.0", user: userProfile.name, detector: userProfile.detector }
                            ]
                        }
                    ];
                }

                if (storedProfile) {
                    // Update userProfile only if storedProfile exists and is valid
                    const tempProfile = JSON.parse(storedProfile);
                    if (tempProfile && tempProfile.name && tempProfile.detector) {
                         userProfile = tempProfile;
                    }
                } else {
                    // Re-initialize sample profile if needed
                    userProfile = { name: "Sample Dectorist", detector: "Minelab Equinox" };
                }

                if (storedUserId) {
                    userId = storedUserId;
                } else {
                    userId = generateId();
                }

                saveSurveysToLocalStorage(); // Ensure initial data and ID are saved
            } catch (e) {
                console.error("Error loading from Local Storage:", e);
                showMessage("Error loading data. Data may be reset.", 'error');
            }
        }

        /** Renders the current page content into the main container. */
        function render() {
            const appContent = document.getElementById('app-content');
            let contentHtml = '';

            // Update navigation button styles
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.page === currentPage) {
                    btn.classList.add('text-primary', 'bg-gray-100');
                    btn.classList.remove('text-gray-500', 'hover:text-primary');
                } else {
                    btn.classList.remove('text-primary', 'bg-gray-100');
                    btn.classList.add('text-gray-500', 'hover:text-primary');
                }
            });

// In the render function...
        
        // Cleanup: Always clear the interval and GPS watch when rendering a new page content,
        // the Compass page will restart it if needed.
        if (autoRefreshIntervalId) {
            clearInterval(autoRefreshIntervalId);
            autoRefreshIntervalId = null;
            console.log("Auto-refresh stopped.");
        }
        // ADDED: Clear the live map GPS watch
        if (liveMapWatchId) {
            navigator.geolocation.clearWatch(liveMapWatchId);
            liveMapWatchId = null;
            bestLiveAccuracy = Infinity;
            console.log("Live Map GPS Watch stopped.");
        }

        switch (currentPage) {
        // ... (rest of the switch statement)                
               case 'Home':
                    contentHtml = renderHomePage();
                    break;
                case 'Targets':
                    contentHtml = renderTargetsPage();
                    break;
                case 'Compass':
                    // Initial render of the Compass page (starts the interval)
                    contentHtml = renderCompassPage(false); 
                    break;
                case 'Settings':
                    contentHtml = renderSettingsPage();
                    break;
                default:
                    contentHtml = `<div class="p-4 text-center">Page Not Found</div>`;
            }

            appContent.innerHTML = contentHtml;
            // Re-attach event listeners specific to the rendered page
            attachPageEventListeners();
        }

        /** Attaches event listeners for dynamically rendered elements */
        function attachPageEventListeners() {
            // For Home Page (New Survey Button)
            const newSurveyBtn = document.getElementById('new-survey-btn');
            if (newSurveyBtn) {
                newSurveyBtn.addEventListener('click', showNewSurveyModal);
            }
            // For Targets Page (Log New Target Button)
            const addTargetBtn = document.getElementById('add-target-btn');
            if (addTargetBtn) {
                addTargetBtn.addEventListener('click', showNewTargetModal);
            }
            // For Settings Page (Export/Import Buttons)
            const exportBtn = document.getElementById('export-data-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportData);
            }
            const importBtn = document.getElementById('import-data-btn');
            if (importBtn) {
                importBtn.addEventListener('click', importData);
            }
        }

        // --- GPS GEOLOCATION FUNCTIONS ---
        
   /** Starts a high-accuracy GPS stream that updates the inputs live. */
/** * Starts a high-accuracy GPS stream that updates the target logging modal's
 * inputs only when a reading is more accurate than the current best.
 */
/** * Starts a high-accuracy GPS stream that updates the target logging modal's
 * inputs only when a reading is more accurate than the current best.
 */
function startTargetLocationWatch() {
    // 1. Get references to the HTML elements
    const coordsInput = document.getElementById('target-coords');
    const accuracyInput = document.getElementById('target-accuracy');
    
    // NOTE: The visible text span is now inside the p tag with the ID 'gps-accuracy-display'
    const accuracyDisplayP = document.getElementById('gps-accuracy-display');
    const accuracyValueSpan = accuracyDisplayP.querySelector('.font-semibold');
    
    const loadingIndicator = document.getElementById('gps-loading-indicator');
    
    // Local variable to track the best accuracy received so far
    let bestAccuracy = Infinity; 

    // 2. Reset UI state for a new acquisition process
    coordsInput.value = '';
    coordsInput.placeholder = 'Waiting for GPS lock...';
    coordsInput.disabled = true;
    accuracyInput.value = '';
    
    // Ensure only the loading indicator is visible initially, hide the accuracy display
    accuracyValueSpan.textContent = 'N/A';
    accuracyDisplayP.classList.add('hidden'); // Hide the visible P tag
    loadingIndicator.classList.remove('hidden'); // Show the loading indicator SPAN

    if (navigator.geolocation) {
        // 3. Start Watching (Stream)
        targetWatchId = navigator.geolocation.watchPosition(
            // Success Callback: Processes incoming positions
            (position) => {
                const accuracy = position.coords.accuracy;
                
                // --- CORE LOGIC: ONLY UPDATE IF THIS READING IS MORE ACCURATE ---
                if (accuracy < bestAccuracy) {
                    bestAccuracy = accuracy; // Update the best accuracy found
                    
                    const lat = position.coords.latitude.toFixed(6);
                    const lon = position.coords.longitude.toFixed(6);

                    // Update visible and hidden inputs with the better reading
                    coordsInput.value = `${lat}, ${lon}`;
                    coordsInput.placeholder = 'GPS Locked';
                    coordsInput.disabled = false; // Enable fields

                    accuracyInput.value = accuracy.toFixed(2);
                    accuracyValueSpan.textContent = `${accuracy.toFixed(1)} meters`;

                    // Update UI color based on the BEST accuracy
                    if(accuracy < 5) {
                        accuracyValueSpan.className = "font-semibold text-green-600"; // Good!
                    } else if (accuracy < 15) {
                        accuracyValueSpan.className = "font-semibold text-yellow-600"; // Okay
                    } else {
                        accuracyValueSpan.className = "font-semibold text-red-600"; // Poor
                    }
                    
                    console.log(`New Best Accuracy: ${accuracy.toFixed(1)}m`);
                } 
                // --- END CORE LOGIC ---
                
                // FINAL STEP: Hide loading and SHOW accuracy display
                loadingIndicator.classList.add('hidden');
                accuracyDisplayP.classList.remove('hidden'); 

            }, // Success callback ends here
            
            // Error Callback: Handles GPS failure
            (error) => {
                console.error('GPS Watch Error:', error);
                loadingIndicator.classList.add('hidden');
                accuracyDisplayP.classList.remove('hidden');
                accuracyValueSpan.textContent = 'Error';
                accuracyValueSpan.className = "font-semibold text-red-600";
                coordsInput.placeholder = 'GPS Error (Type Manually)';
                coordsInput.disabled = false;
                showMessage(`GPS Error: ${error.message}. Please input coordinates manually.`, 'error');
            },
            
            // Options Object
            {
                enableHighAccuracy: true, 
                timeout: 30000,           
                maximumAge: 0             
            }
        );
    } else {
        showMessage('Geolocation is not supported on this device.', 'error');
    }
}
        
        function stopTargetLocationWatch() {
    if (targetWatchId !== null) {
        navigator.geolocation.clearWatch(targetWatchId);
        targetWatchId = null;
        console.log("Target GPS Watch stopped.");
    }
}
        
// --- LIVE MAP GPS WATCH FUNCTIONS (New/Modified Logic) ---

        /** Starts a continuous, high-accuracy GPS stream that only updates the state when a reading is more accurate. 
         * Also starts the 5-second rendering interval.
         */
        function startLiveMapLocationWatch() {
            if (!navigator.geolocation) {
                currentUserCoords = null;
                currentUserAccuracy = null;
                showMessage('Geolocation is not supported on this device.', 'error');
                return;
            }
            
            // Reset best accuracy for a fresh start
            bestLiveAccuracy = Infinity; 
            
            // 1. Start continuous watchPosition (Runs in the background)
            liveMapWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const accuracy = position.coords.accuracy;
                    
                    // Core Logic: Only update the global state if this reading is more accurate
                    if (accuracy < bestLiveAccuracy) {
                        bestLiveAccuracy = accuracy; 
                        
                        currentUserCoords = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        currentUserAccuracy = accuracy;
                        
                        console.log(`Live Map New Best Accuracy: ${accuracy.toFixed(1)}m`);
                    } 
                }, 
                
                // Error Callback
                (error) => {
                    currentUserCoords = null;
                    currentUserAccuracy = null;
                    console.error('Live Map GPS Watch Error:', error);
                },
                
                // Options Object: High accuracy, no timeout (watch is continuous), maximumAge=0
                {
                    enableHighAccuracy: true, 
                    maximumAge: 0             
                }
            );

            // 2. Start the 5-second rendering interval (if not already running)
            if (autoRefreshIntervalId === null) {
                autoRefreshIntervalId = setInterval(() => {
                    updateMapWithUserLocationAndRender();
                }, 5000); // 5000 milliseconds = 5 seconds
                console.log("Live Map GPS Watch and 5-second rendering interval started.");
            }
        }

        /** Wrapper function to re-render Compass page for auto-refresh using the latest watched GPS data. */
        function updateMapWithUserLocationAndRender() {
            // The GPS data is updated asynchronously by startLiveMapLocationWatch().
            // We just trigger the re-render here.
            
            const appContent = document.getElementById('app-content');
            // Only re-render if we are still on the Compass page
            if (currentPage === 'Compass') { 
                appContent.innerHTML = renderCompassPage(true); 
                attachPageEventListeners();
            }
        }
        
        // --- MODAL & TOAST FUNCTIONS ---

        /** Shows a temporary notification toast. */
        function showMessage(message, type = 'info') {
            const toast = document.getElementById('message-toast');
            toast.textContent = message;

            let bgColor = 'bg-gray-700'; // Default info
            if (type === 'success') {
                bgColor = 'bg-secondary';
            } else if (type === 'error') {
                bgColor = 'bg-red-600';
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-500';
            }

            toast.className = `fixed bottom-4 right-4 z-50 p-4 rounded-lg text-white shadow-xl transition-opacity duration-300 opacity-100 ${bgColor}`;

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        }

        /** Shows the generic confirmation modal. */
        function showConfirmationModal(title, message, onConfirmCallback) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirm-title').innerHTML = title;
            document.getElementById('confirm-message').innerHTML = message;
            
            const yesBtn = document.getElementById('confirm-yes-btn');
            const noBtn = document.getElementById('confirm-no-btn');

            const handleYes = () => {
                onConfirmCallback();
                closeConfirmationModal();
                yesBtn.removeEventListener('click', handleYes);
            };

            yesBtn.onclick = handleYes;
            noBtn.onclick = closeConfirmationModal;
            
            modal.style.display = 'block';
        }

        /** Closes the generic confirmation modal. */
        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
        }

        /** Shows the New Survey Modal and attaches the submit listener. */
        function showNewSurveyModal() {
            // Reset the form whenever the modal is opened
            document.getElementById('new-survey-form').reset();
            document.getElementById('new-survey-modal').style.display = 'block';

            // Ensure the submit listener is attached only once
            const form = document.getElementById('new-survey-form');
            // Remove previous listener to prevent multiple submissions
            form.removeEventListener('submit', handleNewSurveySubmit); 
            form.addEventListener('submit', handleNewSurveySubmit); 
        }

        /** Closes the New Survey Modal. */
        function closeNewSurveyModal() {
            document.getElementById('new-survey-modal').style.display = 'none';
        }

        /** Handles the submission of the New Survey form. */
        function handleNewSurveySubmit(event) {
            event.preventDefault();

            const form = event.target;
            const name = form['surveyName'].value.trim();
            const description = form['surveyDescription'].value.trim() || 'No description provided.';
            const now = Date.now();

            if (!name) {
                showMessage('Survey Name is required.', 'error');
                return;
            }

            // 1. Close any currently open survey
            surveys.forEach(s => {
                if (s.status === 'Open') {
                    s.status = 'Active';
                    s.dateLastChanged = now;
                }
            });

            // 2. Create the new survey object
            const newSurvey = {
                id: generateId(),
                name: name,
                description: description,
                status: 'Open', // Automatically opens the new survey
                creationDate: now,
                dateLastChanged: now,
                targets: []
            };

            // 3. Add the new survey to the start of the list
            surveys.unshift(newSurvey);

            // 4. Save and re-render
            saveSurveysToLocalStorage();
            closeNewSurveyModal();
            showMessage(`New Survey '${name}' created and is now OPEN!`, 'success');
            render();
        }

        /** Shows the New Target Modal. */
        function showNewTargetModal() {
            const openSurvey = surveys.find(s => s.status === 'Open');
            if (!openSurvey) {
                return showMessage('Cannot log target. Please open a survey first on the Home page.', 'warning');
            }

            // 1. Set survey name in the modal header
            document.getElementById('current-target-survey-name').textContent = openSurvey.name;
            
            // 2. Reset the form
            document.getElementById('new-target-form').reset();
            
            // 3. Request GPS location
            startTargetLocationWatch();
            
            // 4. Display modal
            document.getElementById('new-target-modal').style.display = 'block';

            // 5. Attach the submit listener
            const form = document.getElementById('new-target-form');
            form.removeEventListener('submit', handleNewTargetSubmit); 
            form.addEventListener('submit', handleNewTargetSubmit); 
        }

        /** Closes the New Target Modal. */
        function closeNewTargetModal() {
            stopTargetLocationWatch();
            document.getElementById('new-target-modal').style.display = 'none';
        }

        /** Handles the submission of the New Target form. */
        function handleNewTargetSubmit(event) {
            event.preventDefault();

            const openSurvey = surveys.find(s => s.status === 'Open');
            if (!openSurvey) {
                showMessage('Error: No open survey found to log the target against.', 'error');
                return;
            }

            const form = event.target;
            const description = form['targetDescription'].value.trim();
            const vdi = form['targetVDI'].value.trim() || 'N/A';
            const depth = form['targetDepth'].value.trim() || 'Unknown';
            const type = form['targetType'].value;
            const coords = form['targetCoords'].value.trim() || 'No GPS logged';
            const accuracy = form['targetAccuracy'].value.trim() || 'N/A'; // NEW: Get accuracy
            const now = Date.now();

            if (!description) {
                showMessage('A description is required for the target.', 'error');
                return;
            }

            // Create the new target object
            const newTarget = {
                id: generateId(),
                description: description,
                vdi: vdi,
                depth: depth,
                type: type,
                status: 'Signal Detected', // Initial status
                time: now,
                coordinates: coords,
                accuracy: accuracy,       // NEW: Log Accuracy
                user: userProfile.name,      // Pulled from userProfile state
                detector: userProfile.detector // Pulled from userProfile state
            };

            // 1. Add the new target to the open survey (at the beginning of the array for reverse chronological view)
            openSurvey.targets.unshift(newTarget);
            openSurvey.dateLastChanged = now;

            // 2. Save and re-render
            saveSurveysToLocalStorage();
            closeNewTargetModal();
            showMessage(`Target '${description}' successfully logged in ${openSurvey.name}.`, 'success');
            
            // Switch to Targets page automatically to view the new entry
            currentPage = 'Targets'; 
            render();
        }

        /** Shows the Edit Target Modal and loads current data. */
        function showEditTargetModal(targetId, surveyId) {
            const survey = surveys.find(s => s.id === surveyId);
            if (!survey) return showMessage('Error: Survey not found.', 'error');
            
            const target = survey.targets.find(t => t.id === targetId);
            if (!target) return showMessage('Error: Target not found.', 'error');

            // 1. Populate the form
            document.getElementById('edit-target-id').value = target.id;
            document.getElementById('edit-survey-id').value = survey.id;
            document.getElementById('current-edit-survey-name').textContent = survey.name;
            
            document.getElementById('edit-target-description').value = target.description;
            document.getElementById('edit-target-vdi').value = target.vdi === 'N/A' ? '' : target.vdi;
            document.getElementById('edit-target-depth').value = target.depth === 'Unknown' ? '' : target.depth;
            document.getElementById('edit-target-type').value = target.type;
            document.getElementById('edit-target-coords').value = target.coordinates === 'No GPS logged' ? '' : target.coordinates;
            // NEW: Populate accuracy field
            document.getElementById('edit-target-accuracy').value = target.accuracy === 'N/A' ? '' : target.accuracy;


            // 2. Display the modal
            const modal = document.getElementById('edit-target-modal');
            modal.style.display = 'block';

            // 3. Attach the submit listener
            const form = document.getElementById('edit-target-form');
            form.removeEventListener('submit', handleEditTargetSubmit); 
            form.addEventListener('submit', handleEditTargetSubmit); 
        }

        /** Closes the Edit Target Modal. */
        function closeEditTargetModal() {
            document.getElementById('edit-target-modal').style.display = 'none';
        }

        /** Handles the submission of the Edit Target form. */
        function handleEditTargetSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const targetId = form['targetId'].value;
            const surveyId = form['surveyId'].value;
            const newDescription = form['targetDescription'].value.trim();
            const newVDI = form['targetVDI'].value.trim() || 'N/A';
            const newDepth = form['targetDepth'].value.trim() || 'Unknown';
            const newType = form['targetType'].value;
            const newCoords = form['targetCoords'].value.trim() || 'No GPS logged';
            const newAccuracy = form['targetAccuracy'].value.trim() || 'N/A'; // NEW: Get accuracy

            const survey = surveys.find(s => s.id === surveyId);
            const target = survey ? survey.targets.find(t => t.id === targetId) : null;

            if (target && survey) {
                target.description = newDescription;
                target.vdi = newVDI;
                target.depth = newDepth;
                target.type = newType;
                target.coordinates = newCoords;
                target.accuracy = newAccuracy; // NEW: Update accuracy
                
                survey.dateLastChanged = Date.now();

                // Save and re-render
                saveSurveysToLocalStorage();
                closeEditTargetModal();
                showMessage(`Target '${newDescription}' updated successfully!`, 'success');
                render();
            } else {
                showMessage('Error: Target or Survey not found during submission.', 'error');
            }
        }

        /** Shows the Edit Profile Modal and loads current data. */
        function showEditProfileModal() {
            const modal = document.getElementById('edit-profile-modal');
            // Pre-fill the form with current profile data
            document.getElementById('profile-name').value = userProfile.name;
            document.getElementById('profile-detector').value = userProfile.detector;
            modal.style.display = 'block';

            // Attach the submit listener
            const form = document.getElementById('edit-profile-form');
            form.removeEventListener('submit', handleEditProfileSubmit); 
            form.addEventListener('submit', handleEditProfileSubmit); 
            showMessage("Edit Profile modal opened. Please enter your name and detector and click 'Save Changes'.", 'info');
        }

        /** Closes the Edit Profile Modal. */
        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').style.display = 'none';
        }

        /** Handles the submission of the Edit Profile form. */
        function handleEditProfileSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const newName = form['profileName'].value.trim();
            const newDetector = form['profileDetector'].value.trim();

            if (!newName || !newDetector) {
                showMessage('Both Name and Detector are required.', 'error');
                return;
            }

            // Update global state
            userProfile.name = newName;
            userProfile.detector = newDetector;

            // Update user/detector in existing targets 
            surveys.forEach(survey => {
                survey.targets.forEach(target => {
                    if (target.user === userProfile.name) {
                        target.user = newName;
                    }
                    if (target.detector === userProfile.detector) {
                        target.detector = newDetector;
                    }
                });
            });


            // Save and re-render
            saveSurveysToLocalStorage();
            closeEditProfileModal();
            showMessage(`Profile updated to "${newName}" using "${newDetector}" successfully!`, 'success');
            // Re-render the current page (Settings) to reflect the new profile data
            render();
        }

        // --- SURVEY & TARGET LOGIC (Action Handlers) ---

        /** Handles actions like 'open', 'close', 'archive', 'restore', 'delete'. */
        function handleSurveyAction(button) {
            const id = button.dataset.id;
            const action = button.dataset.action;
            const name = button.dataset.name;
            const survey = surveys.find(s => s.id === id);
            if (!survey) return;

            const executeAction = () => {
                const now = Date.now();
                switch (action) {
                    case 'open':
                        // Close any currently open survey first
                        surveys.forEach(s => {
                            if (s.status === 'Open') {
                                s.status = 'Active';
                                s.dateLastChanged = now;
                            }
                        });
                        survey.status = 'Open';
                        showMessage(`Survey '${name}' is now OPEN.`, 'success');
                        break;
                    case 'close':
                        survey.status = 'Active';
                        showMessage(`Survey '${name}' is now CLOSED (Active).`, 'info');
                        break;
                    case 'archive':
                        survey.status = 'Archived';
                        showMessage(`Survey '${name}' has been Archived.`, 'info');
                        break;
                    case 'restore':
                        survey.status = 'Active';
                        showMessage(`Survey '${name}' Restored to Active.`, 'success');
                        break;
                    case 'delete':
                        surveys = surveys.filter(s => s.id !== id);
                        showMessage(`Survey '${name}' permanently deleted. 'error`);
                        break;
                }
                survey.dateLastChanged = now;
                saveSurveysToLocalStorage();
                render();
            };

            // Use confirmation modal for irreversible or significant actions
            if (action === 'delete') {
                showConfirmationModal(
                    `Confirm Delete: ${name}`,
                    `Are you sure you want to permanently delete the survey **${name}** and all its targets? This action cannot be undone.`,
                    executeAction
                );
            } else if (action === 'archive') {
                showConfirmationModal(
                    `Confirm Archive: ${name}`,
                    `Are you sure you want to Archive the survey **${name}**? You can restore it later.`,
                    executeAction
                );
            } else {
                executeAction();
            }
        }

        /** Handles actions on individual targets. */
        function handleTargetAction(element) {
            const action = element.dataset.action;
            const targetId = element.dataset.id;
            const surveyId = element.dataset.surveyId;
            const survey = surveys.find(s => s.id === surveyId);
            if (!survey) return;
            const target = survey.targets.find(t => t.id === targetId);
            if (!target) return;

            if (action === 'edit') {
                // Special case: open the edit modal
                showEditTargetModal(targetId, surveyId);
                return;
            }

            const executeAction = () => {
                switch (action) {
                    case 'setStatus':
                        const newStatus = element.dataset.status;
                        target.status = newStatus;
                        showMessage(`Target status updated to: ${newStatus}`, 'success');
                        break;
                    case 'delete':
                        survey.targets = survey.targets.filter(t => t.id !== targetId);
                        showMessage(`Target deleted.`, 'error');
                        break;
                }
                survey.dateLastChanged = Date.now();
                saveSurveysToLocalStorage();
                render();
            };

            if (action === 'delete') {
                showConfirmationModal(
                    `Confirm Delete Target: ${target.description}`,
                    `Are you sure you want to permanently delete this target?`,
                    executeAction
                );
            } else {
                executeAction();
            }
        }

        // --- PAGE RENDER FUNCTIONS ---

function renderHomePage() {
    const openSurvey = surveys.find(s => s.status === 'Open');
    const activeSurveys = surveys.filter(s => s.status === 'Active');
    const archivedSurveys = surveys.filter(s => s.status === 'Archived');

    const renderSurveyList = (list) => {
        if (list.length === 0) {
            return `<p class="text-gray-500 italic p-4">No surveys in this section.</p>`;
        }
        // Pass the openSurvey ID to highlight the currently open survey card in the list
        return list.map(s => renderSurveyCard(s, s.id === (openSurvey ? openSurvey.id : null))).join('');
    };

    // CRITICAL FIX: The template literal must start on the same line as 'return'
    return `<div class="p-4">
        <h2 class="text-3xl font-bold text-primary mb-6">Survey Dashboard</h2>

        <div class="bg-white p-4 rounded-xl shadow-lg mb-6 border-l-4 border-yellow-500">
            <h3 class="text-xl font-bold text-yellow-700 mb-2">
                ${openSurvey ? openSurvey.name : 'No Open Survey'}
            </h3>
            ${openSurvey ? 
                `<p class="text-gray-700">Open since: ${formatDate(openSurvey.creationDate)} (${openSurvey.targets.length} targets logged)</p>
                 ${renderSurveyCard(openSurvey, true)}` 
                : 
                '<p class="text-gray-600">You must open or create a survey to log new targets.</p>'
            }
        </div>

        <button id="new-survey-btn" class="w-full text-center text-white font-bold py-3 px-4 rounded-lg shadow-md hover:opacity-90 transition duration-150 mb-6" style="background-color: rgb(var(--color-secondary));">
            <i class="fas fa-plus-circle mr-2"></i> Create New Survey
        </button>

        <h3 class="text-2xl font-bold text-gray-700 mb-3">Active/Closed Surveys (${activeSurveys.length})</h3>
        <div id="active-surveys-list" class="space-y-4 mb-8">
            ${renderSurveyList(activeSurveys)}
        </div>

        <h3 class="text-2xl font-bold text-gray-700 mb-3">Archived Surveys (${archivedSurveys.length})</h3>
        <div id="archived-surveys-list" class="space-y-4">
            ${renderSurveyList(archivedSurveys)}
        </div>
    </div>`; // Note the closing backtick here
}        /** Renders a single survey card with action buttons based on status. */
        function renderSurveyCard(survey, isOpen = false) {
            let actions = '';
            let statusBadge = '';
            // Get the secondary color variable for inline styles
            const secondaryColor = 'rgb(var(--color-secondary))';

            switch (survey.status) {
                case 'Open':
                    statusBadge = `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">OPEN</span>`;
                    // 'Close' button is yellow
                    actions = `
                        <button class="survey-action-btn bg-yellow-500 hover:bg-yellow-600 p-2 text-black text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="close" data-name="${survey.name}">Close</button>
                        <button class="survey-action-btn bg-red-500 hover:bg-red-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="archive" data-name="${survey.name}">Archive</button>
                    `;
                    break;
                case 'Active': // Active but Closed
                    statusBadge = `<span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">ACTIVE</span>`;
                    // 'Open' button uses the secondary (green) color via inline style
                    actions = `
                        <button class="survey-action-btn p-2 text-white text-sm font-semibold rounded-md shadow-sm hover:opacity-90" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="open" data-name="${survey.name}" style="background-color: ${secondaryColor};">Open</button>
                        <button class="survey-action-btn bg-gray-500 hover:bg-gray-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="archive" data-name="${survey.name}">Archive</button>
                        <button class="survey-action-btn bg-red-500 hover:bg-red-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="delete" data-name="${survey.name}">Delete</button>
                    `;
                    break;
                case 'Archived':
                    statusBadge = `<span class="bg-gray-100 text-gray-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">ARCHIVED</span>`;
                    actions = `
                        <button class="survey-action-btn bg-blue-500 hover:bg-blue-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="restore" data-name="${survey.name}">Restore</button>
                        <button class="survey-action-btn bg-red-500 hover:bg-red-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm" onclick="handleSurveyAction(this)" data-id="${survey.id}" data-action="delete" data-name="${survey.name}">Delete</button>
                    `;
                    break;
            }

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 ${isOpen ? 'border-yellow-500' : 'border-primary'}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-lg font-bold text-gray-800">${statusBadge}${survey.name}</h4>
                        <div class="flex space-x-2">
                            ${actions}
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${survey.description}</p>
                    <div class="flex justify-between text-xs text-gray-400 border-t border-gray-100 pt-2 mt-2">
                        <span>Created: ${formatDate(survey.creationDate)}</span>
                        <span>Targets: ${survey.targets.length}</span>
                        <span>Last Change: ${formatDate(survey.dateLastChanged)}</span>
                    </div>
                </div>
            `;
        }

        /** Renders the content for the Targets page. */
        function renderTargetsPage() {
            const openSurvey = surveys.find(s => s.status === 'Open');

            if (!openSurvey) {
                return `
                    <div class="p-4">
                        <h2 class="text-3xl font-bold text-primary mb-6">Survey Targets</h2>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                            <h3 class="text-xl font-bold text-red-600 mb-3">No Open Survey</h3>
                            <p class="text-gray-700">Please open a survey on the **Home** page to view or log targets.</p>
                        </div>
                    </div>
                `;
            }

            const targets = openSurvey.targets;

            return `
                <div class="p-4">
                    <h2 class="text-3xl font-bold text-primary mb-6">Targets: ${openSurvey.name}</h2>
                    
                    <button id="add-target-btn" class="w-full text-center text-white font-bold py-3 px-4 rounded-lg shadow-md hover:opacity-90 transition duration-150 mb-6" style="background-color: rgb(var(--color-secondary));">
                        <i class="fas fa-crosshairs mr-2"></i> Log New Target
                    </button>

                    <h3 class="text-2xl font-bold text-gray-700 mb-3">Target Log (${targets.length})</h3>
                    <div id="targets-list" class="space-y-4">
                        ${targets.length === 0 ? 
                            '<p class="text-gray-500 italic p-4 bg-white rounded-xl shadow-lg">No targets logged in this survey yet.</p>' : 
                            targets.map(t => renderTargetCard(t, openSurvey.id)).join('')}
                    </div>
                </div>
            `;
        }

        /** Renders a single target card. */
        function renderTargetCard(target, surveyId) {
            let typeColor = 'bg-primary';
            let typeIcon = 'fas fa-gem';

            switch (target.type) {
                case 'Coin':
                    typeColor = 'bg-yellow-500';
                    typeIcon = 'fas fa-coins';
                    break;
                case 'Relic':
                    typeColor = 'bg-red-500';
                    typeIcon = 'fas fa-shield-alt';
                    break;
                case 'Jewelry':
                    typeColor = 'bg-pink-500';
                    typeIcon = 'fas fa-ring';
                    break;
                case 'Modern Junk':
                    typeColor = 'bg-gray-500';
                    typeIcon = 'fas fa-trash';
                    break;
                case 'Iron Junk':
                    typeColor = 'bg-gray-700';
                    typeIcon = 'fas fa-magnet';
                    break;
                case 'Unidentified':
                    typeColor = 'bg-purple-500';
                    typeIcon = 'fas fa-question';
                    break;
            }

            let statusClass = 'bg-green-100 text-green-800';
            let statusIcon = `<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            let actionDropdown = '';

            switch (target.status) {
                case 'Signal Detected':
                    statusClass = 'bg-green-100 text-green-800';
                    actionDropdown = `
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Hole Dug" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-yellow-700 hover:bg-gray-100"> Mark: Hole Dug </a>
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Hole Refilled" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-primary hover:bg-gray-100"> Mark: Hole Refilled </a>
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Signal Ignored" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"> Mark: Signal Ignored </a>
                    `;
                    break;
                case 'Hole Dug':
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusIcon = `<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>`;
                    actionDropdown = `
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Signal Detected" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100"> Mark: Signal Detected </a>
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Hole Refilled" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-primary hover:bg-gray-100"> Mark: Hole Refilled </a>
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Signal Ignored" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"> Mark: Signal Ignored </a>
                    `;
                    break;
                case 'Hole Refilled':
                    statusClass = 'bg-secondary/10 text-secondary';
                    statusIcon = `<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4M18 5h2M17 19h4m-7-6l-3-3 6-6m-3 9l3-3 6-6"></path></svg>`;
                    actionDropdown = `
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Signal Detected" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100"> Mark: Signal Detected </a>
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Hole Dug" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-yellow-700 hover:bg-gray-100"> Mark: Hole Dug </a>
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Signal Ignored" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"> Mark: Signal Ignored </a>
                    `;
                    break;
                case 'Signal Ignored':
                    statusClass = 'bg-gray-100 text-gray-800';
                    statusIcon = `<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                    actionDropdown = `
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Signal Detected" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100"> Mark: Signal Detected </a>
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Hole Dug" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-yellow-700 hover:bg-gray-100"> Mark: Hole Dug </a>
                        <a href="#" onclick="handleTargetAction(this)" data-action="setStatus" data-status="Hole Refilled" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-primary hover:bg-gray-100"> Mark: Hole Refilled </a>
                    `;
                    break;
            }

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4" style="border-left-color: ${typeColor};">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="${typeIcon} mr-2 text-lg" style="color: ${typeColor};"></i>
                            ${target.description}
                            <span class="ml-3 text-sm text-white font-semibold px-2 py-0.5 rounded-full" style="background-color: ${typeColor};">${target.type}</span>
                        </h4>
                        
                        <div class="relative inline-block text-left target-dropdown-container">
                            <button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-2 py-1 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-primary" id="dropdownMenuButton-${target.id}" aria-expanded="true" aria-haspopup="true" onclick="this.nextElementSibling.classList.toggle('hidden')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            
                            <div class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="dropdownMenuButton-${target.id}">
                                    ${actionDropdown}
                                    <div class="border-t border-gray-100"></div>
                                    <a href="#" onclick="handleTargetAction(this)" data-action="edit" data-id="${target.id}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"> Edit Details </a>
                                    <a href="#" onclick="handleTargetAction(this)" data-action="delete" data-id="${target.id}" data-name="${target.description}" data-survey-id="${surveyId}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50"> Delete Target </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-xs font-semibold px-2.5 py-0.5 rounded-full inline-flex items-center ${statusClass}">
                        ${statusIcon} ${target.status}
                    </p>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm mt-3 pt-3 border-t border-gray-100">
                        <div>
                            <strong class="text-gray-500">Target ID:</strong>
                            <span class="text-gray-800">${target.vdi}</span>
                        </div>
                        <div>
                            <strong class="text-gray-500">Depth:</strong>
                            <span class="text-gray-800">${target.depth}</span>
                        </div>
                        <div>
                            <strong class="text-gray-500">Accuracy:</strong>
                            <span class="text-gray-800">${target.accuracy && target.accuracy !== 'N/A' ? target.accuracy + 'm' : 'N/A'}</span>
                        </div>
                        <div>
                            <strong class="text-gray-500">Coords:</strong>
                            <span class="text-gray-800 break-all">${target.coordinates.split(',')[0] || target.coordinates}...</span>
                        </div>

                        <div class="col-span-2 sm:col-span-4 text-xs text-gray-400">
                            Logged at ${new Date(target.time).toLocaleTimeString()} on ${formatDate(target.time)} by ${target.user} (${target.detector})
                        </div>
                    </div>
                </div>
            `;
        }
        
 /** Renders a static plot of targets based on relative coordinates. */
function renderTargetPlot(targets) {
    
    // --- DEBUG HARDCODE (STEP 1: REMOVE LATER) ---
    // Fix accuracy to 10m for debugging the circle size.
    const DEBUG_ACCURACY = 10;
    const DEBUG_MAP_RANGE_METERS = 30;
    // ---------------------------------------------
    
    // Haversine approximation constants
    const M_PER_DEG_LAT = 110574; // meters per degree latitude (relatively constant)
    const M_PER_DEG_LON_AT_EQUATOR = 111320; // meters per degree longitude (at equator)
    
    // Use the debug accuracy for the plot (or fallback to original if debug is disabled/zero)
    const userAccuracy = currentUserCoords ? (DEBUG_ACCURACY || currentUserAccuracy || 0) : 0;
    const diameterInMeters = userAccuracy * 2;
    const bufferPercentage = 0.05;

    // 1. Parse targets and prepare for Bounding Box calculation
    const parsedCoords = targets.map(t => {
        const parts = t.coordinates.split(',').map(c => parseFloat(c.trim()));
        return {
            lat: parts[0],
            lon: parts[1],
            description: t.description,
            type: t.type,
            vdi: t.vdi,
            status: t.status,
            accuracy: parseFloat(t.accuracy) || 0,
            isUser: false
        };
    }).filter(c => !isNaN(c.lat) && !isNaN(c.lon));
    let allCoords = [...parsedCoords];

    // Add user's location if available
    if (currentUserCoords) {
        allCoords.push({
            lat: currentUserCoords.lat,
            lon: currentUserCoords.lon,
            description: 'Your Current Location',
            type: 'User',
            vdi: 'N/A',
            accuracy: userAccuracy,
            isUser: true
        });
    }

    if (allCoords.length === 0) {
        return `
            <div class="p-4 text-center bg-gray-100 rounded-lg">
                <p class="text-lg text-gray-500 italic">No valid GPS coordinates found to plot (targets or user location).</p>
            </div>
        `;
    }

    // --- DEBUG HARDCODE (STEP 2: REMOVE LATER) ---
    // Override Bounding Box calculation to enforce a 30m map width centered on user.
    let minLat, maxLat, minLon, maxLon;
    let latRange, lonRange;
    let mapWidthMeters, mapHeightMeters;

    if (currentUserCoords) {
        // Center map on user location
        const centerLat = currentUserCoords.lat;
        const centerLon = currentUserCoords.lon;
        
        const meanLatForConversion = toRad(centerLat);
        const metersPerDegreeLon = M_PER_DEG_LON_AT_EQUATOR * Math.cos(meanLatForConversion);

        // Calculate degrees required for 30m total range (15m on either side)
        const latChangeDeg = (DEBUG_MAP_RANGE_METERS / M_PER_DEG_LAT) / 2;
        const lonChangeDeg = (DEBUG_MAP_RANGE_METERS / metersPerDegreeLon) / 2;

        minLat = centerLat - latChangeDeg;
        maxLat = centerLat + latChangeDeg;
        minLon = centerLon - lonChangeDeg;
        maxLon = centerLon + lonChangeDeg;
        
        latRange = maxLat - minLat;
        lonRange = maxLon - minLon;
        
        // These should now be exactly 30m (or very close)
        mapHeightMeters = latRange * M_PER_DEG_LAT;
        mapWidthMeters = lonRange * metersPerDegreeLon;

    } else {
        // Fallback to previous logic if no user location is available (shouldn't happen with targets)
        // Find the true geographical bounding box of ALL points (targets + user)
        minLat = allCoords[0].lat; maxLat = allCoords[0].lat;
        minLon = allCoords[0].lon; maxLon = allCoords[0].lon;

        allCoords.forEach(c => {
            minLat = Math.min(minLat, c.lat);
            maxLat = Math.max(maxLat, c.lat);
            minLon = Math.min(minLon, c.lon);
            maxLon = Math.max(maxLon, c.lon);
        });
        
        // Simplified fallback for ranges and meters
        latRange = maxLat - minLat;
        lonRange = maxLon - minLon;
        const finalMeanLat = toRad((minLat + maxLat) / 2);
        const metersPerDegreeLon = M_PER_DEG_LON_AT_EQUATOR * Math.cos(finalMeanLat);
        mapHeightMeters = latRange * M_PER_DEG_LAT;
        mapWidthMeters = lonRange * metersPerDegreeLon;

    }
    // ---------------------------------------------
    
    // 2. Normalize and generate pins HTML
    const pinsHtml = allCoords.map(t => {
        // Calculate position percentages (0% to 100%)

        // X-axis (Longitude): East is right
        const xRaw = ((t.lon - minLon) / lonRange) * 100;
        // Y-axis (Latitude): North is UP, but CSS 'top' is DOWN. Invert Y-axis.
        const yRaw = ((maxLat - t.lat) / latRange) * 100;

        // Clamp values to ensure they are within the 0-100% boundary
        const xPercent = clamp(xRaw, 0, 100);
        const yPercent = clamp(yRaw, 0, 100);

        let pinHtml = '';
        let labelHtml = '';

        if (t.isUser) {
            let confidenceCircleHtml = '';

            // Use the hardcoded 10m accuracy (20m diameter)
            if (userAccuracy > 0) {
                
                // CRITICAL CALCULATION: Use the fixed map dimensions for scaling
                const scaleFactor = Math.max(mapWidthMeters, mapHeightMeters) / 100; // Meters per 1% of the largest dimension (Should be 0.3m/1%)
                
                const diameterPercent = diameterInMeters / scaleFactor; // 20m / 0.3m/1% = 66.67%

                // Set both dimensions to the same percentage to maintain a circle
                const diameterXPercent = diameterPercent;
                const diameterYPercent = diameterPercent;
                
                // Confidence Circle HTML
                confidenceCircleHtml = `
                    <div class="absolute rounded-full border-2 border-red-500 bg-red-500/10 pointer-events-none"
                        style="
                            width: ${diameterXPercent.toFixed(2)}%; 
                            height: ${diameterYPercent.toFixed(2)}%;
                            min-width: 4px; 
                            min-height: 4px;
                            /* Center the circle on the user's coordinates */
                            left: 50%; top: 50%;
                            transform: translate(-50%, -50%);
                            z-index: 30; 
                        "
                        title="Confidence Radius: ${t.accuracy.toFixed(1)}m (DEBUGGED)">
                    </div>
                `;
            }

            // User Pin: Blue Triangle
            pinHtml = `
                ${confidenceCircleHtml}
                <div class="relative w-0 h-0 border-l-[2px] border-r-[2px] border-b-[4px] border-l-transparent border-r-transparent border-b-blue-600 shadow-xl cursor-pointer z-10"></div>
            `;

            labelHtml = `
                <span class="absolute whitespace-nowrap text-xs font-bold text-white bg-blue-600 p-1 rounded-sm shadow border border-blue-800"
                    style="left: 100%; top: 50%; transform: translateY(-50%) translateX(5px);">
                    ${t.description}
                </span>
            `;
        } else {
            // Target Pin: Colored Dot with Label
            let pinColor = 'bg-primary';
            let pinSize = 'w-2 h-2';

            // START of new STATUS-BASED logic
            switch (t.status) {
                case 'Signal Detected':
                    pinColor = 'bg-green-600';
                    pinSize = 'w-3 h-3';
                    break;
                case 'Hole Dug':
                    pinColor = 'bg-yellow-500';
                    break;
                case 'Find Retrieved':
                case 'Hole Refilled':
                    pinColor = 'bg-blue-600';
                    break;
                case 'Signal Ignored':
                    pinColor = 'bg-gray-500';
                    break;
                default:
                    pinColor = 'bg-primary';
            }
            // END of new STATUS-BASED logic

            pinHtml = `<div class="${pinSize} rounded-full ${pinColor} border-2 border-primary shadow-lg cursor-pointer"></div>`;


            labelHtml = `
                <span class="absolute whitespace-nowrap text-xs font-semibold text-gray-800 bg-white p-1 rounded-sm shadow border border-gray-300"
                    style="left: 100%; top: 50%; transform: translateY(-50%) translateX(5px);">
                    ${t.description} (Acc: ${t.accuracy.toFixed(1)}m)
                </span>
            `;
        }

        return `
            <div
                class="absolute"
                style="left: ${xPercent.toFixed(2)}%; top: ${yPercent.toFixed(2)}%; transform: translate(-50%, -50%); z-index: ${t.isUser ? 20 : 10};"
                title="${t.description} (Target ID: ${t.vdi}) - ${t.lat.toFixed(6)}, ${t.lon.toFixed(6)} (Acc: ${t.accuracy.toFixed(1)}m)"
            >
                ${pinHtml}
                
                ${labelHtml}
            </div>
        `;
    }).join('');

    // 3. Return the container HTML with click-to-fullscreen added
    let containerClasses = "relative bg-gray-200 overflow-hidden cursor-pointer transition-all duration-300 group";

    if (isMapFullscreen) {
        // Fullscreen Classes (Fixed position, full width/height)
        containerClasses += " fixed inset-0 z-[100] h-screen w-screen";
    } else {
        // Normal/Small Classes (Square aspect ratio, borders)
        containerClasses += " w-full aspect-square border-4 border-gray-400 rounded-lg my-4";
    }

    // Note: The getCircleDiameter function is assumed to be defined earlier in the script.
    const circleDiameter = getCircleDiameter(currentUserAccuracy);

    return `
        <div onclick="toggleMapFullscreen()" class="${containerClasses}" title="Tap to resize">
            ${pinsHtml}
            <div class="absolute bottom-2 right-2 bg-white/80 px-2 py-1 rounded text-xs text-gray-600 font-bold pointer-events-none group-hover:bg-white">
                <i class="fas fa-expand"></i> ${isMapFullscreen ? 'Tap to Minimize' : 'Tap to Fullscreen'}
            </div>
        </div>
        <div class="text-xs text-gray-500 mt-2">
            <p>Plot shows relative positions within the survey area. Targets are dots, your location is the blue triangle.</p>
            <p class="font-bold text-red-600">DEBUGGING MODE: Map range fixed to ${DEBUG_MAP_RANGE_METERS}m and GPS Accuracy fixed to ${DEBUG_ACCURACY}m.</p>
            <ul class="list-disc list-inside mt-1">
                <li><span class="font-bold">North</span> is towards the top of the box.</li>
                <li><span class="font-bold">East</span> is towards the right of the box.</li>
                <li>Total Targets Plotted: ${parsedCoords.length}</li>
                ${currentUserCoords ?
                    `<li><span class="font-bold text-blue-600">User GPS:</span> ${currentUserCoords.lat.toFixed(6)}, ${currentUserCoords.lon.toFixed(6)}</li>
                     <li><span class="font-bold text-red-600">GPS Accuracy (Radius):</span> ${userAccuracy.toFixed(1)}m (Fixed)</li>
                     <li><span class="font-bold text-red-600">Confidence Circle Diameter:</span> ${diameterInMeters.toFixed(1)}m (Fixed)</li>
                    `
                    : `<li><span class="font-bold text-red-600">Warning:</span> No User GPS available.</li>`
                }
            </ul>
        </div>
    `;
}        /** Toggles the map state and re-renders immediately. */
function toggleMapFullscreen() {
    // Toggle the state variable
    isMapFullscreen = !isMapFullscreen;
    
    // Re-render the page immediately so the new class is applied
    // This also resets the auto-refresh timer, which is fine.
    render(); 
}        
     
function renderCompassPage(isAutoRefresh = false) {
    const openSurvey = surveys.find(s => s.status === 'Open');

    if (!openSurvey) {
        // First return path (handles no open survey)
        return `
            <div class="p-4">
                <h2 class="text-3xl font-bold text-primary mb-6">Targets Plot View</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                    <h3 class="text-xl font-bold text-red-600 mb-3">No Open Survey</h3>
                    <p class="text-gray-700">Please open a survey on the **Home** page to view its targets on the plot.</p>
                </div>
            </div>
        `;
    }

    // Start the GPS watch and the 5-second rendering interval ONLY ONCE when navigating to the page manually
    // (This line must be inside the function body, which it is now)
    if (!isAutoRefresh) {
        startLiveMapLocationWatch();
    }
    
    // Filter for targets that actually have usable coordinates
    const targets = openSurvey.targets.filter(t => t.coordinates && t.coordinates.includes(',') && t.coordinates !== 'No GPS logged');

    // Second return path (renders the map view)
    return `
        <div class="p-4">
            <h2 class="text-3xl font-bold text-primary mb-6">Targets Plot View</h2>
            
            <div class="bg-card p-4 rounded-lg shadow-md mb-6 border-l-4 border-primary">
                <h3 class="text-xl font-semibold mb-1 text-gray-700">
                    Viewing Targets for: <span class="text-primary">${openSurvey.name}</span>
                </h3>
                <p class="text-sm text-gray-600">Targets with valid GPS logged: **${targets.length}**</p>
                ${isAutoRefresh ? 
                    `<p class="text-sm text-green-600 mt-2">
                        <i class="fas fa-redo fa-spin mr-1"></i> Auto-refreshing map every 5 seconds...
                    </p>` : ''
                }
            </div>

            <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 mb-8">
                <h3 class="text-xl font-semibold text-gray-700 flex items-center mb-3">
                    <i class="fas fa-dot-circle mr-2"></i> Static Target Plot
                </h3>
                <p class="text-sm text-gray-600 mb-3">
                    This plot shows the relative geographical distribution of all logged targets and your position in the open survey.
                    Your uncertainty is shown with a semi-transparent red confidence circle (Radius = GPS Accuracy).
                </p>
                ${renderTargetPlot(targets)}
            </div>
        </div>
    `;
}
        /** Renders the content for the Settings page. */
        function renderSettingsPage() {
            const secondaryColor = 'rgb(var(--color-secondary))';
            return `
                <div class="p-4">
                    <h2 class="text-3xl font-bold text-primary mb-6">Settings & Local Data Management</h2>

                    <div class="bg-white p-4 rounded-xl shadow-lg mb-8 border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Your Profile</h3>
                        <p class="text-md text-gray-800 mb-1"><strong>Name:</strong> ${userProfile.name}</p>
                        <p class="text-md text-gray-800 mb-4"><strong>Detector:</strong> ${userProfile.detector}</p>
                        
                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <button onclick="showEditProfileModal()" class="px-3 py-2 text-white font-bold rounded-md text-sm hover:opacity-90 transition duration-150" style="background-color: ${secondaryColor};">
                                <i class="fas fa-user-edit mr-1"></i> Edit Profile
                            </button>
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-700 mb-3">Data Export & Import</h3>

                    <div class="bg-white p-4 rounded-xl shadow-lg mb-6 border-l-4 border-primary">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Export Data</h4>
                        <p class="text-sm text-gray-600 mb-3">Export all your surveys and profile data as JSON text to back it up or move it to another device.</p>
                        <button id="export-data-btn" class="w-full bg-primary text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-primary/90 transition duration-150">
                            <i class="fas fa-download mr-1"></i> Export Data (JSON)
                        </button>
                        <textarea id="exported-data-area" rows="5" readonly placeholder="Exported JSON data will appear here..." class="w-full p-2 border border-gray-300 rounded-md font-mono text-xs mt-4 hidden"></textarea>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-lg mb-8 border-l-4 border-yellow-500">
                        <h4 class="text-lg font-semibold text-yellow-700 mb-2">Import Data (Overwrite)</h4>
                        <p class="text-sm text-gray-600 mb-3">Paste the exported JSON text here and click Import. **Warning:** This will overwrite any existing local data on this device.</p>
                        
                        <textarea id="import-data-area" rows="10" placeholder="Paste your exported JSON data here..." class="w-full p-2 border border-yellow-500 rounded-md font-mono text-xs mb-4"></textarea>
                        <button id="import-data-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                            <i class="fas fa-upload mr-1"></i> Import & Overwrite Local Data
                        </button>
                    </div>
                </div>
            `;
        }

        // --- DATA MANAGEMENT FUNCTIONS ---

        /** Exports all data (surveys and profile) to a JSON string and displays it. */
        function exportData() {
            const dataToExport = {
                surveys: surveys,
                profile: userProfile,
                userId: userId,
                exportDate: new Date().toISOString()
            };

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const dataArea = document.getElementById('exported-data-area');
            
            dataArea.value = jsonString;
            dataArea.classList.remove('hidden');
            dataArea.select(); // Select the text for easy copying
            
            // Try to copy to clipboard
            navigator.clipboard.writeText(jsonString).then(() => {
                showMessage('Data copied to clipboard! Paste it safely.', 'success');
            }).catch(err => {
                showMessage('Exported data displayed. Please manually copy the text.', 'warning');
                console.error('Could not copy text: ', err);
            });
        }

        /** Imports data from a JSON string, overwriting existing local storage. */
        function importData() {
            const dataArea = document.getElementById('import-data-area');
            const jsonString = dataArea.value.trim();

            if (!jsonString) {
                return showMessage('Please paste the JSON data into the box.', 'error');
            }

            try {
                const importedData = JSON.parse(jsonString);

                if (!importedData.surveys || !importedData.profile) {
                    throw new Error("Invalid data structure. Missing 'surveys' or 'profile' key.");
                }

                showConfirmationModal(
                    "Confirm Data Import",
                    `Are you sure you want to import data? This will **permanently overwrite** your ${surveys.length} existing local surveys.`,
                    () => {
                        // Overwrite global state
                        surveys = importedData.surveys;
                        userProfile = importedData.profile;
                        userId = importedData.userId || generateId(); // Use existing ID or generate a new one
                        
                        saveSurveysToLocalStorage();
                        dataArea.value = ''; // Clear the input area
                        showMessage('Data successfully imported and saved!', 'success');
                        currentPage = 'Home'; // Navigate to home to show new data
                        render();
                    }
                );
            } catch (e) {
                console.error("Import Error:", e);
                showMessage(`Import failed: ${e.message || 'Invalid JSON format.'}`, 'error');
            }
        }


        // --- INITIALIZATION & EVENT LISTENERS ---

        // Event listener for navigation buttons
        document.querySelectorAll('.nav-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetPage = e.currentTarget.dataset.page;
                if (targetPage && targetPage !== currentPage) {
                    currentPage = targetPage;
                    render();
                }
            });
        });
        
        // 1. Load data first
        loadDataFromLocalStorage();
        showMessage("Data loaded instantly from local storage.", 'success'); // Show initial load message

        // 2. Initial render call
        render();

    </script>
</body>
</html>
