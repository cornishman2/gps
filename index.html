<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Metal Finder v3</title>
<style>
:root{
  --bg:#071018;--card:#0f1724;--accent:#16a34a;--muted:#98a2b3;--glass:rgba(255,255,255,0.03);
  --danger:#ef4444;--arch-tint:rgba(200,200,200,0.08)
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6eef8;background:linear-gradient(180deg,#061019 0%,#0b1320 100%);-webkit-tap-highlight-color:transparent}
.app{max-width:980px;margin:0 auto;padding-bottom:84px}
header{display:flex;gap:12px;align-items:center;padding:12px}
h1{font-size:18px;margin:6px 0}
small{color:var(--muted)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);margin:12px}
.row{display:flex;gap:8px}
input,textarea,select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;width:100%}
input[type=file]{padding:6px}
button{background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
.muted{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px;border-radius:10px}
.small{font-size:12px;padding:6px}
.list{max-height:52vh;overflow:auto;padding:6px;border-radius:8px}
.survey-row,.target-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.01)}
.target-row{flex-direction:column;align-items:stretch}
.target-info{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.target-name{font-weight:600;font-size:14px}
.target-status{color:#16a34a;font-size:13px}
.survey-row.open{background:rgba(22,163,74,0.12);border:1px solid rgba(22,163,74,0.2)}
.survey-row.archived{background:var(--arch-tint);opacity:0.9}
.controls{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.coords{font-family:monospace;font-size:13px;color:var(--muted)}
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:64px;background:rgba(6,8,12,0.96);display:flex;align-items:center;justify-content:space-around;border-top:1px solid rgba(255,255,255,0.03);z-index:50}
.nav-btn{flex:1;text-align:center;color:var(--muted);font-weight:700;cursor:pointer}
.nav-btn.active{color:var(--accent)}
.hidden{display:none}
.arrow-wrap{width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);margin:12px auto}
.arrow{font-size:72px;transform-origin:center;transition:transform 0.2s ease-out}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;background:#111827;color:white;padding:8px 12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.6);display:none;z-index:60}
.divider{text-align:center;color:var(--muted);margin:10px 0;font-size:13px;border-top:1px solid rgba(255,255,255,0.08);padding-top:6px}
@media(min-width:700px){.bottom-nav{max-width:980px;margin:0 auto;left:50%;transform:translateX(-50%)}}
</style>
</head>
<body>
<div class="app">
<header>
  <div>
    <h1>Metal Finder</h1>
    <small>v3 — with archive restore</small>
  </div>
  <div style="margin-left:auto;text-align:right">
    <div class="coords">GPS: <span id="gpsText">unknown</span></div>
    <div class="coords">Accuracy: <span id="accText">—</span> m</div>
  </div>
</header>

<main>
  <section id="screen-home" class="card screen">
    <h3>Home — Surveys</h3>
    <div class="row">
      <input id="detectoristName" placeholder="Detectorist name" />
      <input id="detectorUsed" placeholder="Detector used" />
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnNewSurvey">+ New survey</button>
      <button id="btnNewSurveyAdd" class="muted small">New survey + add target</button>
      <button id="btnCloseSurvey" class="muted small">Close survey</button>
    </div>
    <div style="height:12px"></div>
    <strong>Surveys</strong>
    <div class="list" id="surveyList"></div>
  </section>

  <section id="screen-targets" class="card screen hidden">
    <h3>Targets</h3>
    <div class="row" style="align-items:center">
      <button id="btnAddTarget">+ Add target</button>
      <button id="btnBatch" class="muted small">Batch add</button>
      <div style="margin-left:auto" class="coords">Open survey: <span id="openSurveyName">—</span></div>
    </div>
    <div class="list" id="targetsList"></div>
    <div class="row" style="justify-content:center;margin-top:12px;gap:6px">
      <button id="btnFirstTarget" class="muted small">First</button>
      <button id="btnPrevTarget" class="muted small">Prev</button>
      <button id="btnMarkFound">Mark Found</button>
      <button id="btnNextTarget" class="muted small">Next</button>
      <button id="btnLastTarget" class="muted small">Last</button>
    </div>
  </section>

  <section id="screen-compass" class="card screen hidden">
    <h3>Compass</h3>
    <div style="height:8px"></div>
    <div class="coords" style="font-size:15px">Target: <strong id="compassTargetName">—</strong></div>
    <div class="coords" style="font-size:15px">Device heading: <span id="heading">—</span>°</div>
    <div class="coords" style="font-size:15px">Bearing to target: <span id="bearing">—</span>°</div>
    <div class="coords" style="font-size:14px;color:#16a34a;margin-top:4px"><span id="bearingText">—</span></div>
    <div style="height:8px"></div>
    <div class="arrow-wrap"><div class="arrow" id="arrow">↑</div></div>
  </section>

  <section id="screen-settings" class="card screen hidden">
    <h3>Settings</h3>
    <div class="row" style="align-items:center">
      <button id="btnExport">Export JSON</button>
      <button id="btnImport" class="muted small">Import JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
    <div style="height:8px"></div>
    <div class="row" style="align-items:center">
      <button id="btnClear" class="small">Clear all data</button>
      <div style="margin-left:auto" class="coords">Version: <strong>metal_finder_v3</strong></div>
    </div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<nav class="bottom-nav">
  <div class="nav-btn active" data-screen="home">Home</div>
  <div class="nav-btn" data-screen="targets">Targets</div>
  <div class="nav-btn" data-screen="compass">Compass</div>
  <div class="nav-btn" data-screen="settings">Settings</div>
</nav>
</div>

<script>
(function(){
const STORAGE_KEY='metal_finder_v3_data';
const NAV_INTERVAL_MS=500;
const HEADING_SMOOTH=6;

const toast=document.getElementById('toast');
const screens={
  home:document.getElementById('screen-home'),
  targets:document.getElementById('screen-targets'),
  compass:document.getElementById('screen-compass'),
  settings:document.getElementById('screen-settings')
};
const navBtns=[...document.querySelectorAll('.nav-btn')];
const surveyListEl=document.getElementById('surveyList');
const targetsListEl=document.getElementById('targetsList');
const btnNewSurvey=document.getElementById('btnNewSurvey');
const btnNewSurveyAdd=document.getElementById('btnNewSurveyAdd');
const btnCloseSurvey=document.getElementById('btnCloseSurvey');
const btnAddTarget=document.getElementById('btnAddTarget');
const btnBatch=document.getElementById('btnBatch');
const detectoristNameEl=document.getElementById('detectoristName');
const detectorUsedEl=document.getElementById('detectorUsed');
const openSurveyNameEl=document.getElementById('openSurveyName');
const btnExport=document.getElementById('btnExport');
const btnImport=document.getElementById('btnImport');
const importFileEl=document.getElementById('importFile');
const btnClear=document.getElementById('btnClear');
const compassTargetName=document.getElementById('compassTargetName');
const headingEl=document.getElementById('heading');
const bearingEl=document.getElementById('bearing');
const bearingTextEl=document.getElementById('bearingText');
const arrowEl=document.getElementById('arrow');
const btnNextTarget=document.getElementById('btnNextTarget');
const btnPrevTarget=document.getElementById('btnPrevTarget');
const btnFirstTarget=document.getElementById('btnFirstTarget');
const btnLastTarget=document.getElementById('btnLastTarget');
const btnMarkFound=document.getElementById('btnMarkFound');

let data=load();
data.surveys=data.surveys||[];
let lastPosition=null;
let watchId=null;
let batchInterval=null;
let selectedTargetId=null;
let headingSamples=[];
let smoothedHeading=0;
let lastNav=0;
let hasVibrated=false;
let currentScreen='home';
let selectedTargetIndex=0;

function uid(p='id'){return p+Math.random().toString(36).slice(2,9)}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(data));showToast('Saved')}
function load(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')}catch(e){return{}}}
function showToast(msg){toast.textContent=msg;toast.style.display='block';clearTimeout(toast._t);toast._t=setTimeout(()=>toast.style.display='none',1200)}

function showScreen(name){
  Object.values(screens).forEach(s=>s.classList.add('hidden'));
  screens[name].classList.remove('hidden');
  navBtns.forEach(b=>b.classList.toggle('active',b.dataset.screen===name));
  currentScreen=name;
  if(name==='home')renderSurveys();
  if(name==='targets')renderTargets();
}

navBtns.forEach(b=>b.addEventListener('click',()=>showScreen(b.dataset.screen)));

function getOpenSurvey(){return data.surveys.find(s=>s.status==='Open'&&!s.archived)}
function setOnlyOpen(id){data.surveys.forEach(s=>{s.status=(s.id===id)?'Open':(s.status==='Open'?'Closed':s.status)})}

function createSurvey(name){
  setOnlyOpen(null);
  const s={id:uid('s_'),name:name||('Survey '+new Date().toLocaleString()),createdAt:Date.now(),status:'Open',archived:false,targets:[]};
  data.surveys.push(s);save();renderSurveys();return s;
}

function renderSurveys(){
  surveyListEl.innerHTML='';
  const open=data.surveys.filter(s=>s.status==='Open'&&!s.archived);
  const closed=data.surveys.filter(s=>s.status==='Closed'&&!s.archived);
  const archived=data.surveys.filter(s=>s.archived);
  const sortByDate=a=>a.sort((x,y)=>y.createdAt-x.createdAt);

  sortByDate(open).forEach(s=>addSurveyRow(s,'open'));
  sortByDate(closed).forEach(s=>addSurveyRow(s));
  if(archived.length){
    const div=document.createElement('div');
    div.className='divider';
    div.textContent='Archived Surveys';
    surveyListEl.appendChild(div);
    sortByDate(archived).forEach(s=>addSurveyRow(s,'archived'));
  }
}

function addSurveyRow(s,cls){
  const row=document.createElement('div');
  row.className='survey-row'+(cls?' '+cls:'');
  const statusText=s.archived?'Archived':s.status;
  let btns='';
  if(s.archived){
    btns=`<button class="muted small" data-action="restore" data-id="${s.id}">Restore</button>`;
  }else{
    btns+=`<button class="muted small" data-action="select" data-id="${s.id}">View</button>`;
    if(s.status!=='Open')btns+=`<button class="muted small" data-action="open" data-id="${s.id}">Set Open</button>`;
    if(s.status==='Open')btns+=`<button class="muted small" data-action="close" data-id="${s.id}">Close</button>`;
    btns+=`<button class="muted small" data-action="archive" data-id="${s.id}">Archive</button>`;
    btns+=`<button class="small" style="background:var(--danger);" data-action="delete" data-id="${s.id}">Del</button>`;
  }
  row.innerHTML=`<div style="min-width:0"><strong>${s.name}</strong>
  <div class="coords">${new Date(s.createdAt).toLocaleString()} • ${s.targets.length} targets • ${statusText}</div></div>
  <div class="controls">${btns}</div>`;
  surveyListEl.appendChild(row);
  row.querySelectorAll('button').forEach(b=>b.addEventListener('click',surveyAction));
}

function surveyAction(e){
  const a=e.currentTarget.dataset.action;
  const id=e.currentTarget.dataset.id;
  const s=data.surveys.find(x=>x.id===id);
  if(!s)return;
  if(a==='select'){showScreen('targets');renderTargets();}
  if(a==='open'){setOnlyOpen(id);save();showToast('Set open');renderSurveys();}
  if(a==='close'){s.status='Closed';save();showToast('Closed');renderSurveys();}
  if(a==='archive'){s.archived=true;s.status='Closed';save();showToast('Archived');renderSurveys();}
  if(a==='restore'){s.archived=false;s.status='Closed';save();showToast('Restored');renderSurveys();}
  if(a==='delete'){if(!confirm('Delete survey?'))return;data.surveys=data.surveys.filter(x=>x.id!==id);save();showToast('Deleted');renderSurveys();}
}

function renderTargets(){
  targetsListEl.innerHTML='';
  const open=getOpenSurvey();
  if(!open){
    targetsListEl.innerHTML='<div class="coords">No Open survey — create or set one Open on Home</div>';
    openSurveyNameEl.textContent='—';
    return;
  }
  openSurveyNameEl.textContent=open.name;
  open.targets.forEach(t=>{
    const row=document.createElement('div');
    row.className='target-row';
    const foundStatus=t.found?`<div class="target-status">Found${t.foundNote?' - '+t.foundNote:''}</div>`:'<div class="coords" style="font-size:13px">Not found</div>';
    row.innerHTML=`<div class="target-info">
      <div class="target-name">${t.notes||'Target'}</div>
      <div class="coords" style="font-size:13px">Latitude: ${t.lat.toFixed(6)}</div>
      <div class="coords" style="font-size:13px">Longitude: ${t.lng.toFixed(6)}</div>
      ${foundStatus}
    </div>
    <div class="controls">
      <button class="muted small" data-action="goto" data-id="${t.id}">Go</button>
      <button class="muted small" data-action="edit" data-id="${t.id}">Edit</button>
      <button class="small" style="background:var(--danger);" data-action="delete" data-id="${t.id}">Del</button>
      <button class="muted small" data-action="found" data-id="${t.id}">Mark Found</button>
    </div>`;
    targetsListEl.appendChild(row);
    row.querySelectorAll('button').forEach(b=>b.addEventListener('click',targetAction));
  });
}

function targetAction(e){
  const a=e.currentTarget.dataset.action;
  const id=e.currentTarget.dataset.id;
  const open=getOpenSurvey();
  if(!open)return;
  const t=open.targets.find(x=>x.id===id);
  if(!t)return;
  if(a==='goto'){selectedTargetId=id;showScreen('compass');updateCompass();}
  if(a==='found'){t.found=true;save();renderTargets();}
  if(a==='edit'){const note=prompt('Edit target note',t.notes||'');if(note!==null){t.notes=note;save();renderTargets();}}
  if(a==='delete'){if(!confirm('Delete target?'))return;open.targets=open.targets.filter(x=>x.id!==id);save();renderTargets();}
}

btnNewSurvey.addEventListener('click',()=>{createSurvey(prompt('Survey name?'));});
btnNewSurveyAdd.addEventListener('click',()=>{const s=createSurvey(prompt('Survey name?'));if(s){selectedTargetId=null;showScreen('targets');renderTargets();}});
btnCloseSurvey.addEventListener('click',()=>{const s=getOpenSurvey();if(s){s.status='Closed';save();renderSurveys();}});
btnAddTarget.addEventListener('click',()=>{const open=getOpenSurvey();if(!open){alert('No open survey');return;}const lat=lastPosition?.lat||0,lng=lastPosition?.lng||0;open.targets.push({id:uid('t_'),lat,lng,notes:''});save();renderTargets();});
btnBatch.addEventListener('click',()=>{alert('Batch add not implemented');});
btnMarkFound.addEventListener('click',()=>{const open=getOpenSurvey();if(!open||!selectedTargetId)return;const t=open.targets.find(x=>x.id===selectedTargetId);if(t){t.found=true;save();renderTargets();}});

// Compass navigation buttons
btnNextTarget.addEventListener('click',()=>{const targets=getOpenTargets();if(!targets.length)return;selectedTargetIndex=Math.min(selectedTargetIndex+1,targets.length-1);selectedTargetId=targets[selectedTargetIndex].id;updateCompass();});
btnPrevTarget.addEventListener('click',()=>{const targets=getOpenTargets();if(!targets.length)return;selectedTargetIndex=Math.max(selectedTargetIndex-1,0);selectedTargetId=targets[selectedTargetIndex].id;updateCompass();});
btnFirstTarget.addEventListener('click',()=>{const targets=getOpenTargets();if(!targets.length)return;selectedTargetIndex=0;selectedTargetId=targets[0].id;updateCompass();});
btnLastTarget.addEventListener('click',()=>{const targets=getOpenTargets();if(!targets.length)return;selectedTargetIndex=targets.length-1;selectedTargetId=targets[selectedTargetIndex].id;updateCompass();});

function getOpenTargets(){const open=getOpenSurvey();return open?open.targets:[];}

function updateCompass(){
  const targets=getOpenTargets();
  if(!targets.length)return;
  if(!selectedTargetId)selectedTargetId=targets[0].id;
  selectedTargetIndex=targets.findIndex(t=>t.id===selectedTargetId);
  if(selectedTargetIndex<0)selectedTargetIndex=0;
  selectedTargetId=targets[selectedTargetIndex].id;
  const t=targets[selectedTargetIndex];
  compassTargetName.textContent=t.notes||'Target';
  if(!lastPosition)return;
  const distance=getDistance(lastPosition.lat,lastPosition.lng,t.lat,t.lng);
  const bearingToTarget=getBearing(lastPosition.lat,lastPosition.lng,t.lat,t.lng);
  const diff=(bearingToTarget-smoothedHeading+360)%360;
  let directionText;
  if(diff<10||diff>350)directionText='Straight ahead';
  else if(diff<180)directionText=`Slight right - ${distance.toFixed(0)}m`;
  else directionText=`Slight left - ${distance.toFixed(0)}m`;
  bearingTextEl.textContent=directionText;
  bearingEl.textContent=bearingToTarget.toFixed(0);
  arrowEl.style.transform=`rotate(${diff}deg)`;
}

function toRad(d){return d*Math.PI/180;}
function toDeg(r){return r*180/Math.PI;}
function getDistance(lat1,lon1,lat2,lon2){const R=6371000,dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function getBearing(lat1,lon1,lat2,lon2){const y=Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));return(toDeg(Math.atan2(y,x))+360)%360;}

window.addEventListener('deviceorientationabsolute',e=>{
  if(e.absolute&&e.alpha!==null){
    headingSamples.push(e.alpha);
    if(headingSamples.length>HEADING_SMOOTH)headingSamples.shift();
    smoothedHeading=headingSamples.reduce((a,b)=>a+b,0)/headingSamples.length;
    headingEl.textContent=smoothedHeading.toFixed(0);
    updateCompass();
  }
});

function updateGPS(pos){
  const crd=pos.coords;
  lastPosition={lat:crd.latitude,lng:crd.longitude};
  document.getElementById('gpsText').textContent=crd.latitude.toFixed(6)+', '+crd.longitude.toFixed(6);
  document.getElementById('accText').textContent=crd.accuracy.toFixed(1);
}

if(navigator.geolocation){
  watchId=navigator.geolocation.watchPosition(updateGPS,err=>console.warn(err),{enableHighAccuracy:true});
}

showScreen('home');
})();
</script>
</body>
</html>
