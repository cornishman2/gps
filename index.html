<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Metal Finder v3</title>
<style>
:root{
  --bg:#071018;--card:#0f1724;--accent:#16a34a;--muted:#98a2b3;--glass:rgba(255,255,255,0.03);
  --danger:#ef4444;--arch-tint:rgba(200,200,200,0.08)
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6eef8;background:linear-gradient(180deg,#061019 0%,#0b1320 100%);-webkit-tap-highlight-color:transparent}
.app{max-width:980px;margin:0 auto;padding-bottom:84px}
header{display:flex;gap:12px;align-items:center;padding:12px}
h1{font-size:18px;margin:6px 0}
small{color:var(--muted)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);margin:12px}
.row{display:flex;gap:8px}
input,textarea,select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;width:100%}
input[type=file]{padding:6px}
button{background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
.muted{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px;border-radius:10px}
.small{font-size:12px;padding:6px}
.list{max-height:52vh;overflow:auto;padding:6px;border-radius:8px}
.survey-row,.target-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.01)}
.target-row{flex-direction:column;align-items:stretch}
.target-info{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.target-name{font-weight:600;font-size:14px}
.target-status{color:#16a34a;font-size:13px}
.survey-row.open{background:rgba(22,163,74,0.12);border:1px solid rgba(22,163,74,0.2)}
.survey-row.archived{background:var(--arch-tint);opacity:0.9}
.controls{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.coords{font-family:monospace;font-size:13px;color:var(--muted)}
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:64px;background:rgba(6,8,12,0.96);display:flex;align-items:center;justify-content:space-around;border-top:1px solid rgba(255,255,255,0.03);z-index:50}
.nav-btn{flex:1;text-align:center;color:var(--muted);font-weight:700;cursor:pointer}
.nav-btn.active{color:var(--accent)}
.hidden{display:none}
.arrow-wrap{width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);margin:12px auto}
.arrow{font-size:72px;transform-origin:center;transition:transform 0.3s ease-out}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;background:#111827;color:white;padding:8px 12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.6);display:none;z-index:60}
.divider{text-align:center;color:var(--muted);margin:10px 0;font-size:13px;border-top:1px solid rgba(255,255,255,0.08);padding-top:6px}
@media(min-width:700px){.bottom-nav{max-width:980px;margin:0 auto;left:50%;transform:translateX(-50%)}}  
</style>
</head>
<body>
<div class="app">
<header>
  <div>
    <h1>Metal Finder</h1>
    <small>v3 — with archive restore</small>
  </div>
  <div style="margin-left:auto;text-align:right">
    <div class="coords">GPS: <span id="gpsText">unknown</span></div>
    <div class="coords">Accuracy: <span id="accText">—</span> m</div>
  </div>
</header>

<main>
  <section id="screen-home" class="card screen">
    <h3>Home — Surveys</h3>
    <div class="row">
      <input id="detectoristName" placeholder="Detectorist name" />
      <input id="detectorUsed" placeholder="Detector used" />
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnNewSurvey">+ New survey</button>
      <button id="btnNewSurveyAdd" class="muted small">New survey + add target</button>
      <button id="btnCloseSurvey" class="muted small">Close survey</button>
    </div>
    <div style="height:12px"></div>
    <strong>Surveys</strong>
    <div class="list" id="surveyList"></div>
  </section>

  <section id="screen-targets" class="card screen hidden">
    <h3>Targets</h3>
    <div class="row" style="align-items:center">
      <button id="btnAddTarget">+ Add target</button>
      <button id="btnBatch" class="muted small">Batch add</button>
      <div style="margin-left:auto" class="coords">Open survey: <span id="openSurveyName">—</span></div>
    </div>
    <div class="list" id="targetsList"></div>
  </section>

  <section id="screen-compass" class="card screen hidden">
    <h3>Compass</h3>
    <div style="height:8px"></div>
    <div class="coords" style="font-size:15px">Target: <strong id="compassTargetName">—</strong></div>
    <div class="coords" style="font-size:15px">Device heading: <span id="heading">—</span>°</div>
    <div class="coords" style="font-size:15px">Bearing to target: <span id="bearing">—</span>°</div>
    <div class="coords" style="font-size:14px;color:#16a34a;margin-top:4px"><span id="bearingText">—</span></div>
    <div style="height:8px"></div>
    <div class="arrow-wrap"><div class="arrow" id="arrow">↑</div></div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap">
      <button id="btnFirstTarget" class="muted small">First</button>
      <button id="btnPrevTarget" class="muted small">Prev</button>
      <button id="btnMarkFound">Mark Found</button>
      <button id="btnNextTarget" class="muted small">Next</button>
      <button id="btnLastTarget" class="muted small">Last</button>
    </div>
  </section>

  <section id="screen-settings" class="card screen hidden">
    <h3>Settings</h3>
    <div class="row" style="align-items:center">
      <button id="btnExport">Export JSON</button>
      <button id="btnImport" class="muted small">Import JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
    <div style="height:8px"></div>
    <div class="row" style="align-items:center">
      <button id="btnClear" class="small">Clear all data</button>
      <div style="margin-left:auto" class="coords">Version: <strong>metal_finder_v3</strong></div>
    </div>
  </section>
</main>

<div id="toast" class="toast">Saved</div>

<nav class="bottom-nav">
  <div class="nav-btn active" data-screen="home">Home</div>
  <div class="nav-btn" data-screen="targets">Targets</div>
  <div class="nav-btn" data-screen="compass">Compass</div>
  <div class="nav-btn" data-screen="settings">Settings</div>
</nav>
</div>

<script>
(function(){
const STORAGE_KEY='metal_finder_v3_data';
const NAV_INTERVAL_MS=500;
const HEADING_SMOOTH=6;

const toast=document.getElementById('toast');
const screens={
  home:document.getElementById('screen-home'),
  targets:document.getElementById('screen-targets'),
  compass:document.getElementById('screen-compass'),
  settings:document.getElementById('screen-settings')
};
const navBtns=[...document.querySelectorAll('.nav-btn')];
const surveyListEl=document.getElementById('surveyList');
const targetsListEl=document.getElementById('targetsList');
const btnNewSurvey=document.getElementById('btnNewSurvey');
const btnNewSurveyAdd=document.getElementById('btnNewSurveyAdd');
const btnCloseSurvey=document.getElementById('btnCloseSurvey');
const btnAddTarget=document.getElementById('btnAddTarget');
const btnBatch=document.getElementById('btnBatch');
const detectoristNameEl=document.getElementById('detectoristName');
const detectorUsedEl=document.getElementById('detectorUsed');
const openSurveyNameEl=document.getElementById('openSurveyName');
const btnExport=document.getElementById('btnExport');
const btnImport=document.getElementById('btnImport');
const importFileEl=document.getElementById('importFile');
const btnClear=document.getElementById('btnClear');
const compassTargetName=document.getElementById('compassTargetName');
const headingEl=document.getElementById('heading');
const bearingEl=document.getElementById('bearing');
const bearingTextEl=document.getElementById('bearingText');
const arrowEl=document.getElementById('arrow');
const btnNextTarget=document.getElementById('btnNextTarget');
const btnPrevTarget=document.getElementById('btnPrevTarget');
const btnFirstTarget=document.getElementById('btnFirstTarget');
const btnLastTarget=document.getElementById('btnLastTarget');
const btnMarkFound=document.getElementById('btnMarkFound');

let data=load();
data.surveys=data.surveys||[];
let lastPosition=null;
let watchId=null;
let batchInterval=null;
let selectedTargetId=null;
let headingSamples=[];
let smoothedHeading=0;
let lastNav=0;
let hasVibrated=false;
let currentScreen='home';

function uid(p='id'){return p+Math.random().toString(36).slice(2,9)}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(data));showToast('Saved')}
function load(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')}catch(e){return{}}}
function showToast(msg){toast.textContent=msg;toast.style.display='block';clearTimeout(toast._t);toast._t=setTimeout(()=>toast.style.display='none',1200)}

function showScreen(name){
  Object.values(screens).forEach(s=>s.classList.add('hidden'));
  screens[name].classList.remove('hidden');
  navBtns.forEach(b=>b.classList.toggle('active',b.dataset.screen===name));
  currentScreen=name;
  if(name==='home')renderSurveys();
  if(name==='targets')renderTargets();
  if(name!=='compass')hasVibrated=false;
}
navBtns.forEach(b=>b.addEventListener('click',()=>showScreen(b.dataset.screen)));

function getOpenSurvey(){return data.surveys.find(s=>s.status==='Open'&&!s.archived)}
function setOnlyOpen(id){data.surveys.forEach(s=>{s.status=(s.id===id)?'Open':(s.status==='Open'?'Closed':s.status)})}

function createSurvey(name){
  setOnlyOpen(null);
  const s={id:uid('s_'),name:name||('Survey '+new Date().toLocaleString()),createdAt:Date.now(),status:'Open',archived:false,targets:[]};
  data.surveys.push(s);save();renderSurveys();return s;
}

function renderSurveys(){
  surveyListEl.innerHTML='';
  const open=data.surveys.filter(s=>s.status==='Open'&&!s.archived);
  const closed=data.surveys.filter(s=>s.status==='Closed'&&!s.archived);
  const archived=data.surveys.filter(s=>s.archived);
  const sortByDate=a=>a.sort((x,y)=>y.createdAt-x.createdAt);

  sortByDate(open).forEach(s=>addSurveyRow(s,'open'));
  sortByDate(closed).forEach(s=>addSurveyRow(s));
  if(archived.length){
    const div=document.createElement('div');
    div.className='divider';
    div.textContent='Archived Surveys';
    surveyListEl.appendChild(div);
    sortByDate(archived).forEach(s=>addSurveyRow(s,'archived'));
  }
}

function addSurveyRow(s,cls){
  const row=document.createElement('div');
  row.className='survey-row'+(cls?' '+cls:'');
  const statusText=s.archived?'Archived':s.status;
  let btns='';
  if(s.archived){
    btns=`<button class="muted small" data-action="restore" data-id="${s.id}">Restore</button>`;
  }else{
    btns+=`<button class="muted small" data-action="select" data-id="${s.id}">View</button>`;
    if(s.status!=='Open')btns+=`<button class="muted small" data-action="open" data-id="${s.id}">Set Open</button>`;
    if(s.status==='Open')btns+=`<button class="muted small" data-action="close" data-id="${s.id}">Close</button>`;
    btns+=`<button class="muted small" data-action="archive" data-id="${s.id}">Archive</button>`;
    btns+=`<button class="small" style="background:var(--danger);" data-action="delete" data-id="${s.id}">Del</button>`;
  }
  row.innerHTML=`<div style="min-width:0"><strong>${s.name}</strong>
  <div class="coords">${new Date(s.createdAt).toLocaleString()} • ${s.targets.length} targets • ${statusText}</div></div>
  <div class="controls">${btns}</div>`;
  surveyListEl.appendChild(row);
}

// --- EVENT DELEGATION FOR SURVEYS ---
surveyListEl.addEventListener('click', function(e){
  const btn = e.target.closest('button');
  if(!btn) return;
  const action = btn.dataset.action;
  const id = btn.dataset.id;
  if(!action || !id) return;

  const s = data.surveys.find(x=>x.id===id);
  if(!s) return;

  if(action==='select'){showScreen('targets'); renderTargets();}
  if(action==='open'){setOnlyOpen(id); save(); showToast('Set open'); renderSurveys();}
  if(action==='close'){s.status='Closed'; save(); showToast('Closed'); renderSurveys();}
  if(action==='archive'){s.archived=true; s.status='Closed'; save(); showToast('Archived'); renderSurveys();}
  if(action==='restore'){s.archived=false; s.status='Closed'; save(); showToast('Restored'); renderSurveys();}
  if(action==='delete'){if(confirm('Delete survey?')){data.surveys=data.surveys.filter(x=>x.id!==id); save(); showToast('Deleted'); renderSurveys();}}
});

// --- TARGETS RENDERING ---
function renderTargets(){
  targetsListEl.innerHTML='';
  const open=getOpenSurvey();
  if(!open){
    targetsListEl.innerHTML='<div class="coords">No Open survey — create or set one Open on Home</div>';
    openSurveyNameEl.textContent='—';
    return;
  }
  openSurveyNameEl.textContent=open.name;
  open.targets.forEach(t=>{
    const row=document.createElement('div');
    row.className='target-row';
    const foundStatus=t.found?`<div class="target-status">Found${t.foundNote?' - '+t.foundNote:''}</div>`:'<div class="coords" style="font-size:13px">Not found</div>';
    row.innerHTML=`<div class="target-info">
      <div class="target-name">${t.notes||'Target'}</div>
      <div class="coords" style="font-size:13px">Latitude: ${t.lat.toFixed(6)}</div>
      <div class="coords" style="font-size:13px">Longitude: ${t.lng.toFixed(6)}</div>
      ${foundStatus}
    </div>
    <div class="controls">
      <button class="muted small" data-action="goto" data-id="${t.id}">Go</button>
      <button class="muted small" data-action="mark" data-id="${t.id}">Mark Found</button>
    </div>`;
    targetsListEl.appendChild(row);
  });
}

// --- EVENT DELEGATION FOR TARGETS ---
targetsListEl.addEventListener('click', function(e){
  const btn=e.target.closest('button');
  if(!btn) return;
  const action=btn.dataset.action;
  const id=btn.dataset.id;
  const open=getOpenSurvey();
  if(!open) return;
  const t=open.targets.find(x=>x.id===id);
  if(!t) return;
  if(action==='mark'){markFound(t);}
  if(action==='goto'){selectTarget(t);}
});

function markFound(t){
  const note=prompt('Optional note about found target:','');
  t.found=true;
  if(note)t.foundNote=note;
  save();
  renderTargets();
  showToast('Marked Found');
}

// --- ADD SURVEY ---
btnNewSurvey.addEventListener('click',()=>{
  const name=prompt('Survey name?')||undefined;
  createSurvey(name);
});
btnNewSurveyAdd.addEventListener('click',()=>{
  const name=prompt('Survey name?')||undefined;
  const s=createSurvey(name);
  showScreen('targets');
  renderTargets();
});

// --- ADD TARGET ---
btnAddTarget.addEventListener('click',()=>{
  const open=getOpenSurvey();
  if(!open){alert('No open survey'); return;}
  const notes=prompt('Target notes / description (optional)','');
  const t={id:uid('t_'),lat:lastPosition?.coords?.latitude||0,lng:lastPosition?.coords?.longitude||0,notes,found:false};
  open.targets.push(t);save();renderTargets();
});

// --- GPS ---
function updatePosition(p){
  lastPosition=p;
  document.getElementById('gpsText').textContent=p.coords.latitude.toFixed(6)+', '+p.coords.longitude.toFixed(6);
  document.getElementById('accText').textContent=p.coords.accuracy.toFixed(1);
}
if(navigator.geolocation) navigator.geolocation.watchPosition(updatePosition,err=>{},{enableHighAccuracy:true,maximumAge:2000,timeout:5000});

// --- COMPASS PLACEHOLDER ---
function selectTarget(t){selectedTargetId=t.id;compassTargetName.textContent=t.notes||'Target';showScreen('compass');}
function updateCompass(){
  if(!lastPosition||!selectedTargetId) return;
  const open=getOpenSurvey();if(!open) return;
  const t=open.targets.find(x=>x.id===selectedTargetId);if(!t) return;
  const dx=t.lng-lastPosition.coords.longitude;
  const dy=t.lat-lastPosition.coords.latitude;
  const bearingDeg=(Math.atan2(dx,dy)*180/Math.PI+360)%360;
  // smooth heading
  smoothedHeading+=(bearingDeg-smoothedHeading)/HEADING_SMOOTH;
  arrowEl.style.transform=`rotate(${smoothedHeading}deg)`;
  headingEl.textContent=smoothedHeading.toFixed(0);
  bearingEl.textContent=bearingDeg.toFixed(0);
  bearingTextEl.textContent=bearingDeg>0?'→':'←';
}
setInterval(updateCompass,300);

// --- EXPORT / IMPORT ---
btnExport.addEventListener('click',()=>{const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='metal_finder.json';a.click();});
btnImport.addEventListener('click',()=>importFileEl.click());
importFileEl.addEventListener('change',()=>{const f=importFileEl.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{data=JSON.parse(e.target.result);save();renderSurveys();renderTargets();showToast('Imported')}catch(ex){alert('Import error')}};r.readAsText(f);});

// --- CLEAR ---
btnClear.addEventListener('click',()=>{if(confirm('Clear all data?')){localStorage.removeItem(STORAGE_KEY);data={surveys:[]};renderSurveys();renderTargets();showToast('Cleared');}});

renderSurveys();
})();
</script>
</body>
</html>
