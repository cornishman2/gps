<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dig It! Metal Detecting App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and some custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4F46E5', // Indigo 600
                        'secondary': '#10B981', // Emerald 500
                        'background': '#F9FAFB', // Gray 50
                        'card': '#FFFFFF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styles for Inter font and full screen height */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
        }
        /* Fix the content area height, accounting for the bottom nav */
        .content-area {
            min-height: calc(100vh - 4rem); /* 100vh minus the height of the bottom nav (h-16) */
            padding-bottom: 4rem; /* Ensure content doesn't get hidden behind the fixed footer */
        }
        /* Style for the active navigation button */
        .nav-btn.active {
            color: #4F46E5; /* Primary color */
            font-weight: 600;
        }
        /* Modal Backdrop */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            transition: opacity 0.3s ease-in-out;
        }
        /* Modal Dialog */
        .modal-dialog {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .hidden .modal-dialog {
            transform: scale(0.95);
            opacity: 0;
        }
    </style>
</head>
<body class="min-h-screen antialiased">

    <!-- Main Application Container -->
    <div id="app" class="max-w-3xl mx-auto shadow-xl bg-background">
        
        <!-- Header / Page Title -->
        <header class="p-4 bg-white border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-primary text-center">Dig It! 12:31</h1>
        </header>

        <!-- Main Content Area -->
        <main id="content-area" class="content-area p-4 overflow-y-auto">
            <!-- This is where page content will be rendered -->
        </main>

        <!-- Persistent Bottom Navigation -->
        <footer class="fixed inset-x-0 bottom-0 bg-white border-t border-gray-200 shadow-xl">
            <nav class="flex justify-around items-center h-16 max-w-3xl mx-auto">
                <button class="nav-btn flex flex-col items-center p-2 transition-colors duration-200 active" data-page="home">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10l-2-2m2 2v10a1 1 0 00-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="text-xs mt-1">Home</span>
                </button>
                <button class="nav-btn flex flex-col items-center p-2 transition-colors duration-200" data-page="targets">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3-.895-3-2 1.343-2 3-2zM18.823 6.177A12.016 12.016 0 0012 3C6.477 3 2 7.477 2 13s4.477 10 10 10 10-4.477 10-10a12.016 12.016 0 00-3.177-6.823z"></path></svg>
                    <span class="text-xs mt-1">Targets</span>
                </button>
                <button class="nav-btn flex flex-col items-center p-2 transition-colors duration-200" data-page="compass">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M16 4h2a2 2 0 012 2v6m-4-2H5a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2v-6a2 2 0 00-2-2h-3m-4 0a3 3 0 01-3-3V5h6v4a3 3 0 01-3 3z"></path></svg>
                    <span class="text-xs mt-1">Compass</span>
                </button>
                <button class="nav-btn flex flex-col items-center p-2 transition-colors duration-200" data-page="settings">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="text-xs mt-1">Settings</span>
                </button>
            </nav>
        </footer>
    </div>

    <!-- CUSTOM CONFIRMATION MODAL -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-dialog bg-white w-full max-w-sm mx-auto rounded-xl shadow-2xl p-6 transform">
            <h3 id="modal-title" class="text-xl font-bold text-red-600 mb-3">Confirm Deletion</h3>
            <p id="modal-message" class="text-gray-700 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-150" onclick="handleModalCancel()">
                    Cancel
                </button>
                <button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 transition duration-150" onclick="handleModalConfirm()">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Local Storage Application Logic -->
    <script type="module">
        // --- GLOBAL STATE & LOCAL STORAGE SETUP ---
        const LS_KEY_PROFILE = 'dig_it_user_profile';
        const LS_KEY_SURVEYS = 'dig_it_surveys';
        const LS_KEY_USER_ID = 'dig_it_user_id';
        
        let userId = null; 
        let surveys = []; 
        let userProfile = {}; 
        let currentPage = 'home'; 
        
        // Modal logic globals
        let modalActionCallback = null;

        // --- DATA HELPERS ---

        /** Generates a simple, unique ID. */
        function generateId() {
            return crypto.randomUUID();
        }

        /** Saves the current surveys array to localStorage. */
        function saveSurveysToLocalStorage() {
            try {
                localStorage.setItem(LS_KEY_SURVEYS, JSON.stringify(surveys));
                console.log("Surveys saved to local storage.");
            } catch (error) {
                console.error("Error saving surveys to local storage:", error);
            }
        }

        /** Loads all data from localStorage. */
        function loadDataFromLocalStorage() {
            // 1. User ID (For display consistency, use a sticky ID)
            userId = localStorage.getItem(LS_KEY_USER_ID);
            if (!userId) {
                userId = generateId();
                localStorage.setItem(LS_KEY_USER_ID, userId);
            }

            // 2. User Profile
            try {
                const profileJson = localStorage.getItem(LS_KEY_PROFILE);
                userProfile = profileJson ? JSON.parse(profileJson) : {};
            } catch (e) {
                console.error("Error parsing user profile from local storage, starting fresh.", e);
                userProfile = {};
            }

            // 3. Surveys
            try {
                const surveysJson = localStorage.getItem(LS_KEY_SURVEYS);
                // Parse and ensure targets property exists (for safety)
                surveys = surveysJson ? JSON.parse(surveysJson).map(s => ({ ...s, targets: s.targets || [] })) : [];
            } catch (e) {
                console.error("Error parsing surveys from local storage, starting fresh.", e);
                surveys = [];
            }
            
            // Sort by creation date (newest first)
            surveys.sort((a, b) => new Date(b.creationDate) - new Date(a.creationDate));

            console.log("All data loaded from local storage.");
        }


        /** Helper function to manage status messages in the UI. */
        function showMessage(text, type = 'info') {
            const messageBox = document.getElementById('home-message-box');
            if (!messageBox) return; // Guard if not on home page yet

            messageBox.textContent = text;
            // Reset colors
            messageBox.classList.remove('bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-secondary/10', 'text-secondary-800');
            
            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                default:
                    messageBox.classList.add('bg-secondary/10', 'text-secondary-800');
                    break;
            }
        }

        // --- CUSTOM MODAL LOGIC ---
        
        /** Displays the confirmation modal and sets up the action callbacks. */
        function showConfirmationModal(title, message, confirmCallback) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            modalActionCallback = confirmCallback;
            
            modal.classList.remove('hidden');
        }

        /** Hides the confirmation modal. */
        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
            modalActionCallback = null;
        }

        /** Handles the 'Yes, Delete' button click inside the modal. */
        window.handleModalConfirm = function() {
            if (modalActionCallback) {
                modalActionCallback(); // Execute the stored action
            }
            hideConfirmationModal();
        }

        /** Handles the 'Cancel' button click inside the modal. */
        window.handleModalCancel = function() {
            hideConfirmationModal();
            showMessage("Deletion cancelled.", 'info');
        }
        
        // --- DATA MANIPULATION FUNCTIONS (LOCAL STORAGE CRUD) ---

        /** Saves the user's name and detector to localStorage. */
        function saveUserProfile() {
            const nameInput = document.getElementById('name-input').value.trim();
            const detectorInput = document.getElementById('detector-input').value.trim();
            
            userProfile = {
                name: nameInput,
                detector: detectorInput,
            };

            try {
                localStorage.setItem(LS_KEY_PROFILE, JSON.stringify(userProfile));
                console.log("Profile saved successfully to local storage.");
                showMessage("Profile updated automatically (saved locally).", 'info');
                render();
            } catch (error) {
                console.error("Error saving profile:", error);
                showMessage(`Error saving profile locally: ${error.message}`, 'error');
            }
        }
        
        /** Creates a new survey, automatically setting its status to 'Open'. */
        function createNewSurvey() {
            // Check if an 'Open' survey already exists
            const openSurvey = surveys.find(s => s.status === 'Open');
            if (openSurvey) {
                showMessage(`Error: Please Close or Archive the current Open survey ('${openSurvey.name}') before creating a new one.`, 'error');
                return;
            }
            
            // Generate pre-filled name with current date and time
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const defaultName = `Survey - ${dateStr} ${timeStr}`;

            // Use prompt to get the survey name, pre-filled with the date/time string
            const surveyName = prompt(`Enter a name for the new survey (Pre-filled with date/time, edit as needed):`, defaultName);
            if (!surveyName || surveyName.trim() === '') return;

            // Get the description
            const description = prompt(`Enter a brief description for '${surveyName}':`);
            
            const timestamp = new Date().toISOString();

            const newSurvey = {
                id: generateId(),
                name: surveyName.trim(),
                description: description || 'No description provided.',
                status: 'Open', 
                creationDate: timestamp,
                dateLastChanged: timestamp,
                targets: [] 
            };
            
            surveys.push(newSurvey);
            saveSurveysToLocalStorage();
            loadDataFromLocalStorage(); // Reload and sort
            
            showMessage(`Success: New survey '${surveyName.trim()}' created and set to Open.`, 'success');
            console.log("New survey created locally.");
            
            // Explicitly call render() to refresh the UI
            render();
        }

        /** Updates a survey's status and dateLastChanged. */
        function updateSurveyStatus(surveyId, newStatus) {
            const surveyIndex = surveys.findIndex(s => s.id === surveyId);
            if (surveyIndex === -1) return showMessage("Survey not found.", 'error');

            const surveyName = surveys[surveyIndex].name;

            // Special handling for 'Open': ensure no other survey is open
            if (newStatus === 'Open') {
                const openSurvey = surveys.find(s => s.status === 'Open' && s.id !== surveyId);
                if (openSurvey) {
                    showMessage(`Error: Cannot open this survey. Please Close or Archive the current Open survey ('${openSurvey.name}') first.`, 'error');
                    return;
                }
            }

            surveys[surveyIndex].status = newStatus;
            surveys[surveyIndex].dateLastChanged = new Date().toISOString();
            
            saveSurveysToLocalStorage();
            loadDataFromLocalStorage(); // Reload and sort
            
            showMessage(`Success: Survey '${surveyName}' status updated to '${newStatus}'.`, 'success');
            console.log(`Survey ${surveyId} status updated to ${newStatus}.`);

            // Explicitly call render() to refresh the UI
            render();
        }

        /** Triggers the custom modal for survey deletion. */
        function deleteSurvey(surveyId, surveyName) {
            showConfirmationModal(
                'Confirm Permanent Deletion',
                `Are you sure you want to permanently delete the survey: "${surveyName}"? This action cannot be undone and local data will be lost.`,
                // Confirmation callback (YES)
                () => {
                    surveys = surveys.filter(s => s.id !== surveyId);
                    saveSurveysToLocalStorage();
                    loadDataFromLocalStorage(); 
                    
                    showMessage(`Success: Survey '${surveyName}' was permanently deleted.`, 'success');
                    console.log(`Survey ${surveyId} deleted locally.`);
                    
                    // Crucial: Explicitly call render() to refresh the UI and remove the card.
                    render();
                }
            );
        }

        /** Exports all application data into a JSON string. */
        function exportData() {
            const data = {
                userId: userId,
                userProfile: userProfile,
                surveys: surveys
            };
            const jsonString = JSON.stringify(data, null, 2);
            document.getElementById('export-data-area').value = jsonString;
            showMessage("Data exported successfully. Copy the JSON text above.", 'success');
        }

        /** Imports application data from a JSON string, overwriting local storage. */
        function importData() {
            const importArea = document.getElementById('import-data-area');
            const jsonString = importArea.value.trim();

            if (!jsonString) {
                showMessage("Import failed: Paste JSON data into the box first.", 'error');
                return;
            }

            try {
                const importedData = JSON.parse(jsonString);

                if (!importedData.surveys || !Array.isArray(importedData.surveys)) {
                    showMessage("Import failed: JSON structure is invalid. Missing 'surveys' array.", 'error');
                    return;
                }

                // 1. Update localStorage keys based on imported data
                localStorage.setItem(LS_KEY_USER_ID, importedData.userId || generateId());
                localStorage.setItem(LS_KEY_PROFILE, JSON.stringify(importedData.userProfile || {}));
                localStorage.setItem(LS_KEY_SURVEYS, JSON.stringify(importedData.surveys));
                
                // 2. Reload state and render UI
                loadDataFromLocalStorage();
                render();

                showMessage("Data imported successfully! The app state has been updated.", 'success');

            } catch (error) {
                console.error("Import error:", error);
                showMessage(`Import failed: Invalid JSON format. Please check the pasted text.`, 'error');
            }
        }
        
        /** Adds a new target to the survey currently marked as 'Open'. */
        function addTargetToOpenSurvey() {
            const openSurvey = surveys.find(s => s.status === 'Open');
            if (!openSurvey) {
                showMessage("Error: No survey is currently Open. Please open a survey on the Home page first.", 'error');
                return;
            }

            // --- Simplified Target Data Collection via Prompts ---
            const type = prompt("Enter Target Type (e.g., Coin, Relic, Junk):");
            if (!type) { showMessage("Target logging cancelled.", 'info'); return; }

            const description = prompt("Enter Description (e.g., 1901 Penny, Iron Nail):");
            if (!description) { showMessage("Target logging cancelled.", 'info'); return; }

            const vdi = prompt("Enter VDI Reading (e.g., 12, 8-10):", "N/A");
            const depth = prompt("Enter Depth (e.g., 6 inches, 15 cm):", "Unknown");
            const coordinates = prompt("Enter GPS Coordinates (e.g., 50.123, -5.456):", "N/A - Manual Log");
            // ---------------------------------------------------

            const newTarget = {
                id: generateId(),
                time: new Date().toISOString(),
                type: type.trim(),
                description: description.trim(),
                coordinates: coordinates.trim(),
                depth: depth.trim(),
                vdi: vdi.trim(),
                // Include user/gear data for context
                user: userProfile.name || 'Unknown Digger',
                detector: userProfile.detector || 'Unknown Machine'
            };

            // Find the index to update the survey directly
            const surveyIndex = surveys.findIndex(s => s.id === openSurvey.id);
            if (surveyIndex !== -1) {
                // Add the new target to the start of the targets array (newest first)
                surveys[surveyIndex].targets.unshift(newTarget); 
                surveys[surveyIndex].dateLastChanged = new Date().toISOString();
                
                saveSurveysToLocalStorage();
                loadDataFromLocalStorage(); // Reload and sort
                
                showMessage(`Success: New target '${newTarget.type}' logged to survey '${openSurvey.name}'.`, 'success');
                render(); // Re-render the Targets page
            } else {
                showMessage("Error: Open survey state mismatch during target logging.", 'error');
            }
        }


        // --- UI RENDER FUNCTIONS ---

        /** Main render function, called whenever state changes. */
        function render() {
            const contentArea = document.getElementById('content-area');
            const navButtons = document.querySelectorAll('.nav-btn');

            // Update active navigation button style
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === currentPage);
                btn.classList.remove('text-gray-500');
                btn.classList.add(btn.dataset.page === currentPage ? 'text-primary' : 'text-gray-500');
            });

            // Clear and render the current page content
            contentArea.innerHTML = '';
            switch (currentPage) {
                case 'home':
                    contentArea.innerHTML = renderHomePage();
                    // Attach event listeners for the Home page elements
                    document.getElementById('name-input')?.addEventListener('blur', saveUserProfile);
                    document.getElementById('detector-input')?.addEventListener('blur', saveUserProfile);
                    document.getElementById('create-survey-btn')?.addEventListener('click', createNewSurvey);
                    // Re-attach survey action listeners (must be done after innerHTML update)
                    attachSurveyActionListeners(); 
                    break;
                case 'targets':
                    contentArea.innerHTML = renderTargetsPage();
                    // Attach listener for the new target button
                    document.getElementById('add-target-btn')?.addEventListener('click', addTargetToOpenSurvey);
                    break;
                case 'compass':
                    contentArea.innerHTML = renderCompassPage();
                    break;
                case 'settings':
                    contentArea.innerHTML = renderSettingsPage();
                    document.getElementById('export-data-btn')?.addEventListener('click', exportData);
                    document.getElementById('import-data-btn')?.addEventListener('click', importData);
                    break;
            }
        }

        /** Attaches event listeners to all dynamically generated survey action buttons. */
        function attachSurveyActionListeners() {
            // Re-select all buttons after the page is rendered
            document.querySelectorAll('.survey-action-btn').forEach(button => {
                button.removeEventListener('click', handleSurveyAction); // Prevent double-listening
                button.addEventListener('click', handleSurveyAction);
            });
        }

        /** Handles all survey button clicks based on data attributes. */
        function handleSurveyAction(e) {
            const button = e.currentTarget;
            const action = button.dataset.action;
            const surveyId = button.dataset.id;
            const surveyName = button.dataset.name;

            switch (action) {
                case 'close':
                    updateSurveyStatus(surveyId, 'Active'); // Active but closed
                    break;
                case 'archive':
                    updateSurveyStatus(surveyId, 'Archived'); // Archive (automatically closes)
                    break;
                case 'open':
                    updateSurveyStatus(surveyId, 'Open');
                    break;
                case 'delete':
                    deleteSurvey(surveyId, surveyName);
                    break;
                case 'restore':
                    updateSurveyStatus(surveyId, 'Active'); // Restore to Active/Closed
                    break;
                default:
                    console.error("Unknown survey action:", action);
            }
        }

        /** Helper to format ISO date string to a readable format. */
        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            try {
                return new Date(isoString).toLocaleDateString();
            } catch (e) {
                return 'Invalid Date';
            }
        }

        /** Renders the content for the Home page. */
        function renderHomePage() {
            // Separate surveys by status
            const openSurvey = surveys.find(s => s.status === 'Open');
            const activeSurveys = surveys.filter(s => s.status === 'Active');
            const archivedSurveys = surveys.filter(s => s.status === 'Archived');
            
            return `
                <!-- Message Box: The helper function showMessage manages the content and color -->
                <div id="home-message-box" class="p-3 mb-4 rounded-lg text-sm bg-secondary/10 text-secondary-800">
                    Data loaded instantly from local storage.
                </div>

                <!-- User Profile Inputs -->
                <div class="bg-card p-4 rounded-lg shadow-md mb-6 border border-gray-100">
                    <h2 class="text-xl font-semibold mb-3 text-gray-700">My Gear</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="name-input" class="block text-sm font-medium text-gray-700">Your Name</label>
                            <input type="text" id="name-input" value="${userProfile.name || ''}" placeholder="Enter your name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border">
                        </div>
                        <div>
                            <label for="detector-input" class="block text-sm font-medium text-gray-700">Metal Detector Used</label>
                            <input type="text" id="detector-input" value="${userProfile.detector || ''}" placeholder="e.g., Minelab Equinox 800" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border">
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Changes are saved automatically when you click outside the box.</p>
                    </div>
                </div>

                <!-- Create New Survey Button (MOVED HERE) -->
                <button id="create-survey-btn" class="w-full bg-secondary text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-secondary/90 transition duration-150 mb-8 mt-2 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Create New Survey
                </button>

                <!-- Open Survey Section -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-primary mb-3">Open Survey (1/1)</h2>
                    <div id="open-survey-list" class="space-y-4">
                        ${openSurvey ? renderSurveyCard(openSurvey, true) : '<p class="text-gray-500 italic p-4 bg-white rounded-lg shadow-sm">No survey is currently open and recording targets.</p>'}
                    </div>
                </div>

                <!-- Active Surveys Section -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-primary mb-3">Active (Closed) Surveys</h2>
                    <div id="active-survey-list" class="space-y-4">
                        ${activeSurveys.length > 0 ? activeSurveys.map(s => renderSurveyCard(s)).join('') : '<p class="text-gray-500 italic p-4 bg-white rounded-lg shadow-sm">No active, closed surveys. They are ready to be opened again.</p>'}
                    </div>
                </div>

                <!-- Archived Surveys Section -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-primary mb-3">Archived Surveys</h2>
                    <div id="archived-survey-list" class="space-y-4">
                        ${archivedSurveys.length > 0 ? archivedSurveys.map(s => renderSurveyCard(s)).join('') : '<p class="text-gray-500 italic p-4 bg-white rounded-lg shadow-sm">No archived surveys yet. Great way to tidy up old data!</p>'}
                    </div>
                </div>
            `;
        }
        
        /** Renders a single survey card with action buttons based on status. */
        function renderSurveyCard(survey, isOpen = false) {
            let actions = '';
            let statusBadge = '';
            const disabledAttr = '';
            const disabledClass = '';

            switch (survey.status) {
                case 'Open':
                    statusBadge = `<span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">OPEN</span>`;
                    actions = `
                        <button class="survey-action-btn bg-yellow-500 hover:bg-yellow-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm ${disabledClass}" data-id="${survey.id}" data-action="close" data-name="${survey.name}" ${disabledAttr}>Close</button>
                        <button class="survey-action-btn bg-red-500 hover:bg-red-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm ${disabledClass}" data-id="${survey.id}" data-action="archive" data-name="${survey.name}" ${disabledAttr}>Archive</button>
                    `;
                    break;
                case 'Active': // Active but Closed
                    statusBadge = `<span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">ACTIVE</span>`;
                    actions = `
                        <button class="survey-action-btn bg-secondary hover:bg-secondary/90 p-2 text-white text-sm font-semibold rounded-md shadow-sm ${disabledClass}" data-id="${survey.id}" data-action="open" data-name="${survey.name}" ${disabledAttr}>Open</button>
                        <button class="survey-action-btn bg-red-500 hover:bg-red-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm ${disabledClass}" data-id="${survey.id}" data-action="archive" data-name="${survey.name}" ${disabledAttr}>Archive</button>
                        <button class="survey-action-btn bg-gray-500 hover:bg-gray-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm ${disabledClass}" data-id="${survey.id}" data-action="delete" data-name="${survey.name}" ${disabledAttr}>Delete</button>
                    `;
                    break;
                case 'Archived':
                    statusBadge = `<span class="bg-gray-100 text-gray-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">ARCHIVED</span>`;
                    actions = `
                        <button class="survey-action-btn bg-secondary hover:bg-secondary/90 p-2 text-white text-sm font-semibold rounded-md shadow-sm ${disabledClass}" data-id="${survey.id}" data-action="restore" data-name="${survey.name}" ${disabledAttr}>Restore to Active</button>
                        <button class="survey-action-btn bg-gray-500 hover:bg-gray-600 p-2 text-white text-sm font-semibold rounded-md shadow-sm ${disabledClass}" data-id="${survey.id}" data-action="delete" data-name="${survey.name}" ${disabledAttr}>Delete</button>
                    `;
                    break;
            }

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 ${isOpen ? 'border-green-500' : 'border-primary'}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-gray-800">${statusBadge} ${survey.name}</h3>
                        <div class="text-right text-sm text-gray-500">
                            <p>Created: ${formatDate(survey.creationDate)}</p>
                            <p>Updated: ${formatDate(survey.dateLastChanged)}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${survey.description}</p>
                    <p class="text-sm font-semibold text-gray-700">Targets Logged: ${survey.targets ? survey.targets.length : 0}</p>
                    
                    <div class="mt-4 pt-3 border-t border-gray-100 flex flex-wrap gap-2">
                        ${actions}
                    </div>
                </div>
            `;
        }

        /** Renders the content for the Targets page. */
        function renderTargetsPage() {
            const openSurvey = surveys.find(s => s.status === 'Open');
            const targets = openSurvey ? openSurvey.targets : [];

            let targetsListHtml = '';
            if (targets.length === 0) {
                targetsListHtml = `<p class="text-gray-500 italic p-4 bg-white rounded-lg shadow-sm">No targets logged in this survey yet. Click 'Log New Target' to record your first find!</p>`;
            } else {
                targetsListHtml = targets.map(t => `
                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-secondary">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-lg font-bold text-gray-800">${t.type} <span class="text-sm font-normal text-gray-500 ml-2">(${t.description})</span></h4>
                            <span class="text-xs text-gray-500">${new Date(t.time).toLocaleTimeString()}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-2">
                            <div><strong>VDI:</strong> ${t.vdi}</div>
                            <div><strong>Depth:</strong> ${t.depth}</div>
                            <div class="col-span-2"><strong>Location:</strong> ${t.coordinates}</div>
                        </div>
                        <p class="text-xs text-gray-400">Logged by: ${t.user} (${t.detector})</p>
                    </div>
                `).join('');
            }
            
            const isButtonDisabled = !openSurvey;

            return `
                <div class="p-4">
                    <h2 class="text-3xl font-bold text-primary mb-6">Targets Log</h2>

                    <!-- Current Status & Add Button -->
                    <div class="bg-card p-4 rounded-lg shadow-md mb-6 border border-gray-100">
                        <h3 class="text-xl font-semibold mb-2 text-gray-700">
                            Current Survey: ${openSurvey ? openSurvey.name : '<span class="text-red-500">None Open</span>'}
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">
                            ${openSurvey ? openSurvey.description : 'Open a survey on the Home page to start logging finds.'}
                        </p>

                        <button id="add-target-btn" class="w-full bg-secondary text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-secondary/90 transition duration-150 flex items-center justify-center ${isButtonDisabled ? 'opacity-50 cursor-not-allowed bg-gray-400 hover:bg-gray-400' : ''}" ${isButtonDisabled ? 'disabled' : ''}>
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Log New Target
                        </button>
                    </div>
                    
                    <!-- Targets List -->
                    <h3 class="text-2xl font-bold text-primary mb-3">Survey Targets (${targets.length})</h3>
                    <div id="targets-list" class="space-y-4">
                        ${targetsListHtml}
                    </div>
                </div>
            `;
        }

        /** Renders the content for the Compass page. */
        function renderCompassPage() {
            return `
                <div class="p-4">
                    <h2 class="text-3xl font-bold text-primary mb-6">Compass/GPS Page</h2>
                    <p class="text-gray-700">This page would typically show a compass or map interface to help you log target locations using device GPS. (Functionality coming soon)</p>
                </div>
            `;
        }

        /** Renders the content for the Settings page. */
        function renderSettingsPage() {
            return `
                <div class="p-4">
                    <h2 class="text-3xl font-bold text-primary mb-6">Settings & Local Data Management</h2>

                    <!-- User ID Display -->
                    <div class="mb-8">
                        <p class="text-lg font-semibold text-gray-700">Your Local User ID</p>
                        <p class="mt-2 p-2 bg-gray-100 rounded-lg font-mono text-sm break-all">${userId || 'Error: ID Missing'}</p>
                        <p class="text-xs text-red-500 mt-2">ðŸ›‘ WARNING: This ID ties your data to this browser/device only. This data is NOT synced to the cloud.</p>
                    </div>

                    <!-- Export Section -->
                    <div class="bg-white p-4 rounded-xl shadow-lg mb-8 border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Export Data (Backup / Manual Transfer)</h3>
                        <p class="text-sm text-gray-600 mb-3">Click the button to generate a complete JSON backup of all your surveys and profile data. You can copy this text and save it elsewhere or import it on another device.</p>
                        
                        <button id="export-data-btn" class="w-full bg-primary text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-primary/90 transition duration-150 mb-4">
                            Generate Export JSON
                        </button>
                        <textarea id="export-data-area" rows="10" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 text-xs font-mono"></textarea>
                    </div>

                    <!-- Import Section -->
                    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Import Data (Restore / Manual Transfer)</h3>
                        <p class="text-sm text-gray-600 mb-3">Paste the exported JSON text here and click Import. **Warning:** This will overwrite any existing local data on this device.</p>
                        
                        <textarea id="import-data-area" rows="10" placeholder="Paste your exported JSON data here..." class="w-full p-2 border border-yellow-500 rounded-md font-mono text-xs mb-4"></textarea>
                        <button id="import-data-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                            Import & Overwrite Local Data
                        </button>
                    </div>
                </div>
            `;
        }

        // --- INITIALIZATION & EVENT LISTENERS ---

        // Event listener for navigation buttons
        document.querySelectorAll('.nav-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetPage = e.currentTarget.dataset.page;
                if (targetPage && targetPage !== currentPage) {
                    currentPage = targetPage;
                    render();
                }
            });
        });

        // 1. Load data first
        loadDataFromLocalStorage();
        showMessage("Data loaded instantly from local storage.", 'success'); // Show initial load message

        // 2. Initial render call
        render();

    </script>
</body>
</html>
